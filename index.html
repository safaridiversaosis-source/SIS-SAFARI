<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>SIS — Sistema Interno Safári</title>
<style>
:root{
  --bg-1:#060a18; --bg-2:#0b1430; --bg-3:#0a1024; --panel:#0d1734cc;
  --ink:#f2f6fb; --muted:#a9b5cc; --line:#1d2a49;
  --brand:#57c8ff; --brand2:#2be3e3; --ok:#22c55e; --warn:#f59e0b; --danger:#ef4444;
  --radius:18px; --shadow:0 24px 60px rgba(0,0,0,.45), inset 0 1px 0 rgba(255,255,255,.04);
}
*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0; color:var(--ink);
  font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Ubuntu;
  background: radial-gradient(1000px 800px at 20% -10%, #153b6e 0%, transparent 60%),
              radial-gradient(900px 650px at 90% 0%, #0f2f54 0%, transparent 55%),
              linear-gradient(180deg,var(--bg-2) 0%, var(--bg-1) 55%, var(--bg-3) 100%);
}
.topbar{position:sticky;top:0;z-index:10;display:flex;justify-content:space-between;align-items:center;padding:14px 18px;border-bottom:1px solid var(--line);background:#0b1430b3;backdrop-filter:saturate(120%) blur(8px)}
.brand{display:flex;align-items:center;gap:10px;font-weight:800}
.logo{height:40px}
.btn{background:linear-gradient(180deg,var(--brand),#38b7ff);color:#05141f;border:none;padding:12px 16px;border-radius:14px;font-weight:800;cursor:pointer;transition:.06s transform,.2s box-shadow}
.btn:hover{transform:translateY(-1px);box-shadow:0 16px 28px rgba(92,200,255,.3)}
.btn.ghost{background:transparent;border:1px solid var(--line);color:var(--ink)}
.btn.ok{background:linear-gradient(180deg,#38e07f,#20c760);color:#05140b}
.btn.warn{background:linear-gradient(180deg,#ffc34d,#ffad33)}
.btn.danger{background:linear-gradient(180deg,#ff6b6b,#ff4747)}
.btn.xs{padding:6px 10px;border-radius:10px;font-size:12px}
.btn.sm{padding:8px 12px;border-radius:12px;font-size:13px}
.container{max-width:1200px;margin:28px auto;padding:0 16px}
.row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
.muted{color:var(--muted)} .s{font-size:12px}
.card{background:var(--panel);border:1px solid rgba(255,255,255,.06);border-radius:18px;box-shadow:var(--shadow);backdrop-filter: blur(12px);padding:20px}
.hide{display:none!important}
.field{display:grid;gap:6px}
.field input,.field select,.field textarea{padding:12px 14px;border-radius:14px;border:1px solid rgba(255,255,255,.12);background:rgba(6,18,36,.78);color:var(--ink);outline:none}
.field input:focus,.field select:focus,.field textarea:focus{border-color:rgba(92,200,255,.7);box-shadow:0 0 0 6px rgba(92,200,255,.12)}
.grid-2{display:grid;grid-template-columns:1fr 1fr;gap:14px}
.grid-3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:14px}
@media(max-width:900px){.grid-2,.grid-3{grid-template-columns:1fr}}
.tabs{display:flex;gap:12px;margin-bottom:16px;flex-wrap:wrap}
.tab{background:transparent;color:#fff;border:none;font-weight:800;padding:10px 14px;border-radius:12px;cursor:pointer;opacity:.9}
.tab:hover{opacity:1;transform:translateY(-1px)}
.tab.active{color:var(--brand);box-shadow:0 2px 0 0 var(--brand) inset}
table{width:100%;border-collapse:collapse}
th,td{padding:10px;border-bottom:1px solid var(--line);vertical-align:middle}
thead th{font-size:12px;letter-spacing:.35px;color:#cfe2ff;background:linear-gradient(180deg,rgba(255,255,255,.04),rgba(255,255,255,.02));position:sticky;top:0;z-index:1}
tbody tr:hover{background:rgba(255,255,255,.03)}
td input[type="number"],td input[type="text"]{width:100%;max-width:140px;background:rgba(8,18,36,.7);border:1px solid rgba(255,255,255,.12);color:var(--ink);border-radius:12px;padding:8px 10px}
td input[type="number"]:focus,td input[type="text"]:focus{border-color:rgba(92,200,255,.6)}
.progress{height:12px;background:#0b1220;border:1px solid var(--line);border-radius:10px;overflow:hidden}
.bar{height:100%;background:linear-gradient(90deg,var(--brand),var(--brand2))}
.kpi{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px}
.pill{padding:6px 10px;border-radius:999px;border:1px solid var(--line);background:rgba(6,18,36,.55);font-size:12px}

/* -------- Login bonito (inputs em coluna e sem observações) -------- */
#pageLogin{position:relative;overflow:hidden;min-height:calc(100vh - 64px);display:grid;place-items:center;padding:38px}
.login-wrap{position:relative;width:min(820px,92%);padding:28px;border-radius:24px;background:rgba(7,15,30,.62);border:1px solid rgba(255,255,255,.08);box-shadow:0 30px 80px rgba(0,0,0,.55);backdrop-filter: blur(16px)}
.login-head{display:flex;flex-direction:column;align-items:center;gap:8px;margin-bottom:14px}
.logo-lg{height:94px;filter:drop-shadow(0 10px 18px rgba(0,0,0,.45));animation:floatY 4s ease-in-out infinite}
.title-sis{font-size:62px;font-weight:900;letter-spacing:2px;background:linear-gradient(90deg,var(--brand),#7ef9ff);-webkit-background-clip:text;-webkit-text-fill-color:transparent;text-shadow:0 0 20px rgba(87,200,255,.4);animation:glowPulse 3s ease-in-out infinite}
.subtitle{font-size:18px;color:var(--muted);margin-top:-8px}
.signature{position:fixed;right:16px;bottom:12px;font-size:12px;color:var(--muted);opacity:.9;pointer-events:none}
.signature b{color:#cfe2ff}
@keyframes glowPulse{0%,100%{text-shadow:0 0 18px rgba(87,200,255,.4)}50%{text-shadow:0 0 36px rgba(87,200,255,.9)}}
@keyframes floatY{0%,100%{transform:translateY(0)}50%{transform:translateY(-6px)}}
.blob{position:absolute;filter:blur(50px);opacity:.65;z-index:-1;animation:blob 18s ease-in-out infinite alternate}
.blob.one{width:460px;height:460px;top:-120px;left:-120px;background:radial-gradient(closest-side,#2bd4e3,transparent)}
.blob.two{width:520px;height:520px;bottom:-200px;right:-160px;background:radial-gradient(closest-side,#4fb6ff,transparent);animation-delay:2s}
.blob.three{width:420px;height:420px;bottom:10%;left:15%;background:radial-gradient(closest-side,#2f5cf0,transparent);animation-delay:4s}
@keyframes blob{0%{transform:translate(0,0) scale(1)}50%{transform:translate(20px,-30px) scale(1.1)}100%{transform:translate(-20px,20px) scale(1)}}
.twinkle{position:absolute;inset:0;pointer-events:none}
.dot{position:absolute;width:3px;height:3px;border-radius:50%;background:#c7e7ff66;animation:twinkle 3.6s linear infinite}
@keyframes twinkle{0%{opacity:0}10%{opacity:1}50%{opacity:.2}90%{opacity:1}100%{opacity:0}}
</style>
</head>
<body>

<header class="topbar">
  <div class="brand">
    <img src="logo.png" class="logo" onerror="this.style.display='none'">
    <span>SIS — Sistema Interno Safári</span>
  </div>
  <div id="userNav" class="row hide">
    <span>Olá, <strong id="userName"></strong> — <span id="userRole"></span></span>
    <button class="btn ghost" onclick="logout()">Sair</button>
  </div>
</header>

<main>
  <!-- LOGIN -->
  <section id="pageLogin">
    <div class="blob one"></div><div class="blob two"></div><div class="blob three"></div>
    <div class="twinkle" id="twinkle"></div>

    <div class="login-wrap">
      <div class="login-head">
        <img src="logo.png" class="logo-lg" onerror="this.style.display='none'">
        <div class="title-sis">SIS</div>
        <div class="subtitle">Sistema Interno Safári</div>
      </div>

      <!-- inputs empilhados -->
      <form class="grid-2" onsubmit="return doLogin(event)" style="grid-template-columns:1fr">
        <div class="field">
          <label>Usuário</label>
          <input id="inUser" placeholder="ex.: admin, comercial, diretoria…" required>
        </div>
        <div class="field">
          <label>Senha</label>
          <input id="inPass" type="password" placeholder="•••••" required>
        </div>
        <div class="row" style="justify-content:space-between">
          <button class="btn" type="submit">Entrar</button>
          <button class="btn ghost" type="button" onclick="resetSession()">Resetar sessão</button>
        </div>
      </form>

      <div class="signature">Desenvolvido por <b>Gustavo Morino</b> e <b>Felipe Forato</b></div>
    </div>
  </section>

  <!-- ADMIN -->
  <section id="pageAdmin" class="container hide">
    <div class="tabs" id="adminTabs">
      <button class="tab active" data-tab="dash">Dashboard</button>
      <button class="tab" data-tab="area">Visualizar área</button>
      <button class="tab" data-tab="access">Acessos</button>
    </div>

    <div id="panel-dash" class="panel">
      <div class="card"><h2 style="margin:6px 0 14px">Progresso por área</h2><div id="dashCards" class="row"></div></div>
    </div>

    <div id="panel-area" class="panel hide">
      <div class="card">
        <div class="row" style="justify-content:space-between">
          <h2 style="margin:6px 0">Checklist da área</h2>
          <div class="row">
            <select id="areaSelect" class="field" style="padding:8px 10px;border-radius:10px;border:1px solid var(--line);background:rgba(6,18,36,.75);color:var(--ink)"></select>
            <button class="btn ghost" onclick="exportAreaCSV()">Exportar CSV</button>
          </div>
        </div>
        <div id="areaWrap"></div>
      </div>
    </div>

    <div id="panel-access" class="panel hide">
      <div class="grid-2">
        <div class="card">
          <h2 style="margin:6px 0 12px">Criar novo acesso</h2>
          <div class="form">
            <div class="field"><label>Nome</label><input id="accName"></div>
            <div class="field"><label>Usuário (login)</label><input id="accUser"></div>
            <div class="field"><label>Senha</label><input id="accPass"></div>
            <div class="field"><label>Área/Perfil</label><select id="accRole"></select></div>
            <div class="row" style="justify-content:flex-end"><button class="btn sm" onclick="createAccess()">Criar acesso</button></div>
            <p class="muted s">Obs.: O usuário criado verá apenas o módulo/área escolhida.</p>
          </div>
        </div>
        <div class="card"><h2 style="margin:6px 0 12px">Usuários cadastrados</h2><div id="userList"></div></div>
      </div>
    </div>
  </section>

  <!-- DIRETORIA (Propostas) -->
  <section id="pageDiretoria" class="container hide">
    <div class="card">
      <h2 style="margin:6px 0 12px">Propostas — Aprovação</h2>
      <div id="dirPropsWrap"></div>
      <div id="dirPropDetail"></div>
    </div>
  </section>

  <!-- COMERCIAL -->
  <section id="pageComercial" class="container hide">
    <div class="tabs">
      <button class="tab active" data-tab="prop-new">Abrir Proposta</button>
      <button class="tab" data-tab="prop-my">Minhas Propostas</button>
    </div>

    <div id="panel-prop-new" class="panel">
      <div class="card">
        <h2 style="margin:6px 0 12px">Abrir Proposta</h2>

        <div class="grid-2">
          <div class="field"><label>Início da negociação</label><input id="pIni" type="date"></div>
          <div class="field"><label>Vendedor Safári</label><input id="pVend" placeholder="Seu nome"></div>
        </div>

        <h3 style="margin:12px 0 6px">Dados do Shopping</h3>
        <div class="grid-2">
          <div class="field"><label>Nome do Shopping</label><input id="pShop" placeholder="conforme Google"></div>
          <div class="field"><label>Total de Lojas</label><input id="pTotalLojas" type="number" min="0" placeholder="Ex.: 180"></div>
          <div class="field"><label>Nº oportunidade CRM</label><input id="pCRM"></div>
          <div class="field"><label>Vagas de Estacionamento e Salas de cinema</label><input id="pVagas"></div>
          <div class="field"><label>Administração</label><input id="pAdm"></div>
          <div class="field"><label>Ranking do Google (comparado)</label><input id="pRank"></div>
          <div class="field"><label>Executivo do Shopping (sobrenome)</label><input id="pExec"></div>
          <div class="field"><label>Telefones</label><input id="pTel"></div>
          <div class="field grid-2" style="grid-column:1/-1"><label>Endereço completo</label><input id="pEnd"></div>
        </div>

        <h3 style="margin:12px 0 6px">Proposta do Shopping</h3>
        <div class="grid-2">
          <div class="field"><label>Noite da montagem</label><input id="pMontNoite"></div>
          <div class="field"><label>Noite da desmontagem</label><input id="pDesmNoite"></div>
          <div class="field"><label>Períodos em dias</label><input id="pDias" type="number" min="0"></div>
          <div class="field"><label>Feriados no período</label><input id="pFeriados" placeholder="feriado.com.br"></div>
          <div class="field"><label>Tema</label><input id="pTema"></div>
          <div class="field"><label>Metragem da praça (m²)</label><input id="pM2" type="number" min="0"></div>
          <div class="field"><label>Licenciado? (enviar termo)</label><input id="pLic"></div>
          <div class="field"><label>Quantos pisos</label><input id="pPisos" type="number" min="0"></div>
          <div class="field"><label>Valor</label><input id="pValor"></div>
          <div class="field"><label>Pé direito</label><input id="pPe"></div>
          <div class="field"><label>Qual praça propõe?</label><input id="pPracaProp"></div>
          <div class="field"><label>Qtd de praças no shopping</label><input id="pQtdPracas" type="number" min="0"></div>
          <div class="field"><label>Concorrência no período</label><input id="pConc"></div>
          <div class="field"><label>Bilheteria do concorrente</label><input id="pBilheteConc"></div>
        </div>

        <h3 style="margin:12px 0 6px">Referências de Faturamento</h3>
        <div class="grid-2">
          <div class="field"><label>Se JÁ operamos, qual foi o tema?</label><input id="pTemaAnt"></div>
          <div class="field"><label>Se NÃO operamos, esses valores se referem a qual parque?</label><input id="pRefParque"></div>
          <div class="field"><label>Período</label><input id="pPeriodo"></div>
          <div class="field"><label>Aluguel da época (TOTAL e PROP/MÊS)</label><input id="pAluguel"></div>
          <div class="field grid-2" style="grid-column:1/-1"><label>Faturamento total do período (e proporcional)</label><input id="pFaturamento"></div>
        </div>

        <h3 style="margin:12px 0 6px">Negociação com o Shopping</h3>
        <div class="grid-2">
          <div class="field"><label>1ª contraproposta (data e análise)</label><input id="pCP1"></div>
          <div class="field"><label>2ª contraproposta (data e análise)</label><input id="pCP2"></div>
          <div class="field"><label>3ª contraproposta (data e análise)</label><input id="pCP3"></div>
          <div class="field"><label>4ª contraproposta (data e análise)</label><input id="pCP4"></div>
        </div>
        <div class="grid-2">
          <div class="field"><label>Valor e considerações finais</label><textarea id="pConsider" rows="3"></textarea></div>
          <div class="field"><label>Exigências do shopping</label><textarea id="pExig" rows="3" placeholder="Alvará? Cor de bolinhas?"></textarea></div>
        </div>

        <h3 style="margin:12px 0 6px">Condições para aprovação</h3>
        <div class="grid-3">
          <div class="field"><label>Condições</label><input id="pCond"></div>
          <div class="field"><label>É uma negociação GOLD?</label><select id="pGold"><option>Não</option><option>Sim</option></select></div>
          <div class="field"><label>Comissão (qtd e valor)</label><input id="pComissao"></div>
        </div>

        <div class="row" style="justify-content:flex-end;margin-top:10px">
          <button class="btn" onclick="enviarProposta()">Enviar para Diretoria</button>
        </div>
        <p class="muted s">A Diretoria verá a proposta e poderá aprovar/negar com senha e observação.</p>
      </div>
    </div>

    <div id="panel-prop-my" class="panel hide">
      <div class="card">
        <h2 style="margin:6px 0 12px">Minhas Propostas Enviadas</h2>
        <div id="myPropsWrap"></div>
      </div>
    </div>
  </section>

  <!-- ÁREA (checklists) -->
  <section id="pageArea" class="container hide">
    <div class="card">
      <div class="row" style="justify-content:space-between">
        <div>
          <h2 id="areaTitle" style="margin:6px 0">Checklist da área</h2>
          <p class="muted s">Preencha <b>IDA</b> (Antigo/Novo). Na <b>VOLTA</b>, informe o que voltou; <b>ENVIAR/SOBRA/FALTOU</b> calculam sozinhos.</p>
        </div>
        <div class="row">
          <button class="btn xs ok" onclick="markAll(true)">Marcar todos</button>
          <button class="btn xs ghost" onclick="markAll(false)">Desmarcar</button>
          <button class="btn xs" onclick="saveChecks()">Salvar</button>
          <button class="btn xs ghost" onclick="exportMyCSV()">Exportar CSV</button>
        </div>
      </div>
      <div id="areaTable"></div>
    </div>
  </section>
</main>

<!-- ==================== JS — helpers, storage, Drive sync, UI ==================== -->
<script>
/* ===== Helpers ===== */
const $ = (id)=>document.getElementById(id);
const show = (id)=>$(id)?.classList.remove('hide');
const hide = (id)=>$(id)?.classList.add('hide');
const esc = (s)=>String(s??'').replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
const csvEsc=(s)=>{const x=String(s??'');return /[",\n]/.test(x)?`"${x.replace(/"/g,'""')}"`:x};
const num = (v)=>Number(v)||0;

/* Estrelinhas decorativas no login */
(function(){ 
  const wrap = document.getElementById('twinkle'); 
  if(!wrap) return; 
  let h=''; 
  for(let i=0;i<80;i++){
    h+=`<span class="dot" style="left:${Math.random()*100}%;top:${Math.random()*100}%;animation-duration:${(2+Math.random()*3).toFixed(2)}s;animation-delay:${(Math.random()*3).toFixed(2)}s"></span>`
  } 
  wrap.innerHTML=h; 
})();

/* ===== Chaves ===== */
const KEY_SESSION='sis_session';
const KEY_DATA='sis_checklists';
const KEY_USERS='sis_users';
const KEY_PROPS='sis_propostas';
const KEY_DIR_APPROVERS='sis_dir_approvers';

const ROLES = {
  ADMIN:'ADMIN', COMERCIAL:'COMERCIAL', DIRETORIA:'DIRETORIA',
  PROJETOS:'PROJETOS', ESTOQUE:'ESTOQUE', FABRICACAO:'FABRICACAO',
  PRODUCAO:'PRODUCAO', MARKETING:'MARKETING', GRAFICA:'GRAFICA', LOGISTICA:'LOGISTICA'
};

/* Sessão */
function getUser(){ try{return JSON.parse(localStorage.getItem(KEY_SESSION))}catch{return null} }
function setUser(u){ localStorage.setItem(KEY_SESSION, JSON.stringify(u)) }
function logout(){ localStorage.removeItem(KEY_SESSION); initUI(); }
function resetSession(){
  localStorage.removeItem(KEY_SESSION);
  localStorage.removeItem(KEY_USERS);
  localStorage.removeItem(KEY_DATA);
  localStorage.removeItem(KEY_PROPS);
  localStorage.removeItem(KEY_DIR_APPROVERS);
  location.reload();
}

/* ===== Usuários seed ===== */
const SEED_USERS = [
  {name:'Administrador', username:'admin',      password:'123456', role:ROLES.ADMIN},
  {name:'Comercial',     username:'comercial',  password:'123',    role:ROLES.COMERCIAL},
  {name:'Diretoria',     username:'diretoria',  password:'0000',   role:ROLES.DIRETORIA},
  {name:'Diretoria 1',   username:'diretoria1', password:'7410',   role:ROLES.DIRETORIA},
  {name:'Diretoria 2',   username:'diretoria2', password:'8520',   role:ROLES.DIRETORIA},
  {name:'Diretoria 3',   username:'diretoria3', password:'9630',   role:ROLES.DIRETORIA},
  {name:'Diretoria 4',   username:'diretoria4', password:'1590',   role:ROLES.DIRETORIA},
  {name:'Projetos',      username:'projetos',   password:'123',    role:ROLES.PROJETOS},
  {name:'Estoque',       username:'estoque',    password:'123',    role:ROLES.ESTOQUE},
  {name:'Fabricação',    username:'fabricacao', password:'123',    role:ROLES.FABRICACAO},
  {name:'Produção',      username:'producao',   password:'123',    role:ROLES.PRODUCAO},
  {name:'Marketing',     username:'marketing',  password:'123',    role:ROLES.MARKETING},
  {name:'Gráfica',       username:'grafica',    password:'123',    role:ROLES.GRAFICA},
  {name:'Logística',     username:'logistica',  password:'123',    role:ROLES.LOGISTICA},
];
function seedUsers(arr){
  const map=new Map(arr.map(u=>[u.username.toLowerCase(),u]));
  SEED_USERS.forEach(s=>{ if(!map.has(s.username.toLowerCase())) arr.push(s); });
  localStorage.setItem(KEY_USERS, JSON.stringify(arr));
  return arr;
}
function getUsers(){
  try{
    const raw=localStorage.getItem(KEY_USERS);
    if(raw){ const arr=JSON.parse(raw); if(Array.isArray(arr)) return seedUsers(arr); }
  }catch{}
  localStorage.setItem(KEY_USERS, JSON.stringify(SEED_USERS));
  return JSON.parse(localStorage.getItem(KEY_USERS));
}
function setUsers(list){ localStorage.setItem(KEY_USERS, JSON.stringify(list)) }

/* ===== Aprovadores (Diretoria) ===== */
const SEED_APPROVERS = [
  {name:'Diretor A', pin:'7410'},
  {name:'Diretor B', pin:'8520'},
  {name:'Diretor C', pin:'9630'},
  {name:'Diretor D', pin:'1590'},
];
function getApprovers(){
  try{
    const raw=localStorage.getItem(KEY_DIR_APPROVERS);
    if(raw){ const arr=JSON.parse(raw); if(Array.isArray(arr) && arr.length) return arr; }
  }catch{}
  localStorage.setItem(KEY_DIR_APPROVERS, JSON.stringify(SEED_APPROVERS));
  return JSON.parse(localStorage.getItem(KEY_DIR_APPROVERS));
}
function setApprovers(list){ localStorage.setItem(KEY_DIR_APPROVERS, JSON.stringify(list)) }

/* ===== Checklists ===== */
const row = (item,desc='') => ({
  item, desc,
  antigo:0, novo:0, enviar:0, sobra:0,
  voltou:0, faltou:0,
  apIda:false, apVolta:false
});
const DEFAULT_DATA = {
  [ROLES.PROJETOS]:   [row('Briefing aprovado'), row('Planta 2D'), row('Modelagem 3D/Render'), row('Memorial descritivo'), row('Aprovação cliente')],
  [ROLES.ESTOQUE]:    [row('Mesinha'), row('Tampo mesinha'), row('Assento mesinha'), row('Cavalinhos'), row('Escorregadores')],
  [ROLES.FABRICACAO]: [row('Módulo 1'), row('Módulo 2'), row('Personagem 01'), row('Cama elástica')],
  [ROLES.PRODUCAO]:   [row('Escada'), row('Travessa 1m'), row('Travessa 2m')],
  [ROLES.MARKETING]:  [row('Arte final'), row('Posts/divulgação')],
  [ROLES.GRAFICA]:    [row('Impressão'), row('Refile/laminação')],
  [ROLES.LOGISTICA]:  [row('Veículo definido'), row('Rota & janela de doca')],
};
function getData(){
  try{ const v=JSON.parse(localStorage.getItem(KEY_DATA)); if(v && typeof v==='object') return v; }catch{}
  const copy=JSON.parse(JSON.stringify(DEFAULT_DATA));
  localStorage.setItem(KEY_DATA, JSON.stringify(copy));
  return copy;
}
function setData(o){ localStorage.setItem(KEY_DATA, JSON.stringify(o)) }

/* ===== Propostas ===== */
function getProps(){ try{const p=JSON.parse(localStorage.getItem(KEY_PROPS)); return Array.isArray(p)?p:[]}catch{return[]} }
function setProps(a){ localStorage.setItem(KEY_PROPS, JSON.stringify(a)) }

/* ===== Drive Sync (Apps Script) ===== */
const SIS_API_URL = "https://script.google.com/macros/s/AKfycbzmQkU1l5p1taS93eouEmX0Qdm627g7PHwpdLw1lOevmWOKhrPuY6WOXYi9Kxchpp6y2w/exec";
const CLOUD_DOCS = { users:'users', checklists:'checklists', propostas:'propostas', approvers:'approvers' };

async function driveGet(docId) {
  const url = `${SIS_API_URL}?docId=${encodeURIComponent(docId)}`;
  const r = await fetch(url, { method: 'GET' });
  if (!r.ok) throw new Error('GET ' + r.status);
  const j = await r.json();
  if (j.ok !== true) throw new Error(j.error || 'Erro GET');
  return j.data;
}
async function drivePost(docId, data) {
  const r = await fetch(SIS_API_URL, {
    method: 'POST',
    headers: { 'Content-Type':'application/json' },
    body: JSON.stringify({ docId, data })
  });
  if (!r.ok) throw new Error('POST ' + r.status);
  const j = await r.json();
  if (j.ok !== true) throw new Error(j.error || 'Erro POST');
  return true;
}
async function pullAllFromDrive() {
  try {
    const [u, d, p, a] = await Promise.all([
      driveGet(CLOUD_DOCS.users),
      driveGet(CLOUD_DOCS.checklists),
      driveGet(CLOUD_DOCS.propostas),
      driveGet(CLOUD_DOCS.approvers),
    ]);
    if (u && typeof u === 'object') localStorage.setItem(KEY_USERS, JSON.stringify(u));
    if (d && typeof d === 'object') localStorage.setItem(KEY_DATA, JSON.stringify(d));
    if (Array.isArray(p))           localStorage.setItem(KEY_PROPS, JSON.stringify(p));
    if (Array.isArray(a))           localStorage.setItem(KEY_DIR_APPROVERS, JSON.stringify(a));
    console.log('✅ Puxou do Drive com sucesso');
  } catch (e) {
    console.warn('⚠️ Não conseguiu puxar do Drive. Usando cache local.', e);
    if(!localStorage.getItem(KEY_USERS))         localStorage.setItem(KEY_USERS, JSON.stringify(SEED_USERS));
    if(!localStorage.getItem(KEY_DIR_APPROVERS)) localStorage.setItem(KEY_DIR_APPROVERS, JSON.stringify(SEED_APPROVERS));
    if(!localStorage.getItem(KEY_DATA))          localStorage.setItem(KEY_DATA, JSON.stringify(DEFAULT_DATA));
    if(!localStorage.getItem(KEY_PROPS))         localStorage.setItem(KEY_PROPS, JSON.stringify([]));
  }
}

/* Debounce envio automático */
let _debounceTimer = null;
function _debounce(fn, wait = 1500) { clearTimeout(_debounceTimer); _debounceTimer = setTimeout(fn, wait); }
function _safeParseGet(key, fallback) { try { return JSON.parse(localStorage.getItem(key)) ?? fallback; } catch { return fallback; } }

const _setUsers     = setUsers;
const _setData      = setData;
const _setPropsFn   = setProps;
const _setApprovers = setApprovers;

setUsers = function(list){
  _setUsers(list);
  _debounce(async () => {
    try { await drivePost(CLOUD_DOCS.users, _safeParseGet(KEY_USERS, [])); console.log('⬆️ users -> Drive'); }
    catch(e){ console.warn('Erro enviar users -> Drive', e); }
  });
};
setData = function(obj){
  _setData(obj);
  _debounce(async () => {
    try { await drivePost(CLOUD_DOCS.checklists, _safeParseGet(KEY_DATA, {})); console.log('⬆️ checklists -> Drive'); }
    catch(e){ console.warn('Erro enviar checklists -> Drive', e); }
  });
};
setProps = function(arr){
  _setPropsFn(arr);
  _debounce(async () => {
    try { await drivePost(CLOUD_DOCS.propostas, _safeParseGet(KEY_PROPS, [])); console.log('⬆️ propostas -> Drive'); }
    catch(e){ console.warn('Erro enviar propostas -> Drive', e); }
  });
};
setApprovers = function(arr){
  _setApprovers(arr);
  _debounce(async () => {
    try { await drivePost(CLOUD_DOCS.approvers, _safeParseGet(KEY_DIR_APPROVERS, [])); console.log('⬆️ approvers -> Drive'); }
    catch(e){ console.warn('Erro enviar approvers -> Drive', e); }
  });
};

/* ===== Boot robusto com timeout & fallback ===== */
document.addEventListener('DOMContentLoaded', async () => {
  let inited = false;
  function safeInit() {
    if (!inited && typeof initUI === 'function') {
      inited = true;
      try { initUI(); } catch(e){ console.error('initUI error:', e); }
    }
  }
  const fallbackTimer = setTimeout(() => {
    console.warn('Fallback: iniciando sem sincronizar Drive');
    safeInit();
  }, 2200);
  try {
    const pull = pullAllFromDrive();
    const timeout = new Promise((_, rej) => setTimeout(() => rej(new Error('timeout pullAllFromDrive')), 2000));
    await Promise.race([pull, timeout]);
  } catch (e) {
    console.warn('pullAllFromDrive falhou/timeout:', e);
  } finally {
    clearTimeout(fallbackTimer);
    safeInit();
  }
});

/* ===== Login & Init UI ===== */
function doLogin(ev){
  ev.preventDefault();
  const u = $("inUser").value.trim().toLowerCase();
  const p = $("inPass").value.trim();
  const list = getUsers();
  const user = list.find(x => x.username.toLowerCase() === u && x.password === p);
  if(!user){ alert("Usuário ou senha incorretos."); return false; }
  setUser(user);
  initUI();
  return false;
}
function initUI(){
  const u = getUser();
  hide("pageLogin"); hide("pageAdmin"); hide("pageComercial");
  hide("pageDiretoria"); hide("pageArea");
  $("userNav").classList.add("hide");

  if(!u){ show("pageLogin"); return; }

  $("userName").textContent = u.name;
  $("userRole").textContent = u.role;
  $("userNav").classList.remove("hide");

  switch(u.role){
    case ROLES.ADMIN:      show("pageAdmin"); renderAdmin(); break;
    case ROLES.COMERCIAL:  show("pageComercial"); renderComercial(); break;
    case ROLES.DIRETORIA:  show("pageDiretoria"); renderDiretoria(); break;
    default:               show("pageArea"); renderArea(u.role); break;
  }
}

/* ===== Admin ===== */
function renderAdmin(){
  const roles = Object.values(ROLES);
  const sel = $("accRole");
  sel.innerHTML = roles.map(r=>`<option value="${r}">${r}</option>`).join("");
  renderUserList();
  // Tabs
  const container=$('adminTabs');
  container.querySelectorAll('.tab').forEach(btn=>{
    btn.onclick=()=>{
      container.querySelectorAll('.tab').forEach(b=>b.classList.remove('active'));
      btn.classList.add('active');
      hide('panel-dash'); hide('panel-area'); hide('panel-access');
      if(btn.dataset.tab==='dash'){ show('panel-dash'); renderDashboard(); }
      if(btn.dataset.tab==='area'){ show('panel-area'); fillAreaSelect(); renderAdminAreaView($('areaSelect').value); }
      if(btn.dataset.tab==='access'){ show('panel-access'); }
    };
  });
  renderDashboard();
}
function renderUserList(){
  const u = getUsers();
  $("userList").innerHTML = u.map(x=>`<div class="row" style="justify-content:space-between;border-bottom:1px solid var(--line);padding:4px 0">
    <span><b>${esc(x.name)}</b> (<code>${esc(x.username)}</code>) — ${x.role}</span>
  </div>`).join("");
}
function createAccess(){
  const name=$("accName").value.trim();
  const username=$("accUser").value.trim().toLowerCase();
  const pass=$("accPass").value.trim();
  const role=$("accRole").value;
  if(!name||!username||!pass){ alert("Preencha todos os campos."); return; }
  const u=getUsers();
  if(u.find(x=>x.username===username)){ alert("Usuário já existe."); return; }
  u.push({name,username,password:pass,role});
  setUsers(u);
  alert("Usuário criado!");
  $("accName").value=$("accUser").value=$("accPass").value="";
  renderUserList();
}

/* ===== Dashboard ===== */
function progressOf(area){
  const data=getData()[area]||[]; const total=data.length||1;
  const done=data.filter(r=>r.apIda || r.apVolta).length;
  return {pct:Math.round(100*done/total), done, total};
}
function renderDashboard(){
  const areas=Object.values(ROLES).filter(r=>![ROLES.ADMIN,ROLES.DIRETORIA,ROLES.COMERCIAL].includes(r));
  $("dashCards").innerHTML = areas.map(a=>{
    const p=progressOf(a);
    return `<div class="card" style="min-width:280px">
      <div class="row" style="gap:16px;align-items:center">
        <div class="progress" style="width:120px;height:12px"><div class="bar" style="width:${p.pct}%"></div></div>
        <div>
          <div style="font-weight:900">${a}</div>
          <div class="row"><span class="pill">Concl.: ${p.done}</span><span class="pill">Pend.: ${p.total-p.done}</span></div>
        </div>
        <div class="pill">${p.pct}%</div>
      </div>
    </div>`;
  }).join('');
}

/* ===== Admin > Área ===== */
function fillAreaSelect(){
  const sel=$("areaSelect");
  sel.innerHTML = Object.values(ROLES)
    .filter(r=>![ROLES.ADMIN,ROLES.DIRETORIA,ROLES.COMERCIAL].includes(r))
    .map(r=>`<option>${r}</option>`).join('');
  sel.onchange=()=>renderAdminAreaView(sel.value);
}
function renderAdminAreaView(area){ renderAreaTable(area,'areaWrap',true); }

/* ===== Checklists (render/editar) ===== */
function renderArea(role){
  $("areaTitle").textContent = `Checklist — ${role}`;
  renderAreaTable(role,'areaTable',false);
}
function renderAreaTable(area, targetId, adminView=false){
  const db=getData(); const items=db[area]||[];
  const p=progressOf(area); const target=$(targetId);
  const header=`<div class="row" style="justify-content:space-between;margin-bottom:8px">
    <div class="kpi"><strong>${area}</strong><span>${p.pct}%</span></div>
    <div style="min-width:220px" class="progress"><div class="bar" style="width:${p.pct}%"></div></div>
  </div>`;
  const tools = adminView?`
    <div class="row" style="justify-content:flex-end;margin-bottom:8px">
      <button class="btn xs ok" onclick="markAll(true,'${area}')">Marcar todos</button>
      <button class="btn xs ghost" onclick="markAll(false,'${area}')">Desmarcar</button>
      <button class="btn xs" onclick="saveChecks()">Salvar</button>
      <button class="btn xs ghost" onclick="downloadCSV('${area}')">Exportar CSV</button>
    </div>`:'';
  const table=`
  <div style="overflow:auto">
    <table>
      <thead>
        <tr>
          <th style="min-width:220px">ITEM</th>
          <th style="min-width:200px">DESCRIÇÃO</th>
          <th colspan="4" style="text-align:center">IDA</th>
          <th colspan="2" style="text-align:center">VOLTA</th>
          <th style="min-width:160px">AP.</th>
        </tr>
        <tr>
          <th></th><th></th>
          <th>ANTIGO</th><th>NOVO</th><th>ENVIAR</th><th>SOBRA</th>
          <th>VOLTOU</th><th>FALTOU</th>
          <th>Ida / Volta</th>
        </tr>
      </thead>
      <tbody>
        ${items.map((r,i)=>`
          <tr>
            <td>${esc(r.item)}</td>
            <td><input data-k="desc" data-i="${i}" value="${esc(r.desc||'')}" oninput="editRow(this,'${area}')"></td>

            <td><input type="number" min="0" data-k="antigo" data-i="${i}" value="${num(r.antigo)}" oninput="editRow(this,'${area}')"></td>
            <td><input type="number" min="0" data-k="novo"   data-i="${i}" value="${num(r.novo)}"   oninput="editRow(this,'${area}')"></td>
            <td style="text-align:center"><strong>${num(r.enviar)}</strong></td>
            <td style="text-align:center"><strong>${num(r.sobra)}</strong></td>

            <td><input type="number" min="0" data-k="voltou" data-i="${i}" value="${num(r.voltou)}" oninput="editRow(this,'${area}')"></td>
            <td style="text-align:center"><strong>${num(r.faltou)}</strong></td>

            <td>
              <label class="pill" style="display:inline-flex;gap:6px;align-items:center">
                <input type="checkbox" ${r.apIda?'checked':''} onchange="setAp('${area}',${i},'ida',this)"> Ida
              </label>
              <label class="pill" style="display:inline-flex;gap:6px;align-items:center">
                <input type="checkbox" ${r.apVolta?'checked':''} onchange="setAp('${area}',${i},'volta',this)"> Volta
              </label>
            </td>
          </tr>
        `).join('')}
      </tbody>
    </table>
  </div>`;
  target.innerHTML = header + tools + table;
}
function editRow(el,area){
  const i=+el.dataset.i, k=el.dataset.k;
  const v=(el.type==='number')?Math.max(0,Number(el.value||0)):el.value;
  const db=getData(); const r=db[area][i];
  r[k]=v;
  r.enviar=Math.max(0, num(r.novo)-num(r.antigo));
  r.sobra =Math.max(0, num(r.antigo)-num(r.novo));
  r.faltou=Math.max(0, num(r.enviar)-num(r.voltou));
  setData(db);
  if($('areaTable')) renderAreaTable(area,'areaTable');
  if($('areaWrap'))  renderAreaTable(area,'areaWrap',true);
  renderDashboard();
}
function setAp(area,i,which,el){
  const db=getData(); const r=db[area][i];
  if(which==='ida')  r.apIda   = el.checked;
  if(which==='volta')r.apVolta = el.checked;
  setData(db);
  if($('areaTable')) renderAreaTable(area,'areaTable');
  if($('areaWrap'))  renderAreaTable(area,'areaWrap',true);
  renderDashboard();
}
function markAll(val,areaOpt){
  const area=areaOpt || (getUser()?.role);
  const db=getData(); (db[area]||[]).forEach(r=>{r.apIda=!!val; r.apVolta=val? r.apVolta : false;});
  setData(db);
  if($('areaTable')) renderAreaTable(area,'areaTable');
  if($('areaWrap'))  renderAreaTable(area,'areaWrap',true);
  renderDashboard();
}
function saveChecks(){ alert('Checklist salvo!'); }

/* ===== CSV ===== */
function toCSV(rows){
  const head=['ITEM','DESCRICAO','ANTIGO','NOVO','ENVIAR','SOBRA','VOLTOU','FALTOU','AP_IDA','AP_VOLTA'];
  const lines=rows.map(r=>[
    csvEsc(r.item), csvEsc(r.desc||''), num(r.antigo), num(r.novo), num(r.enviar), num(r.sobra),
    num(r.voltou), num(r.faltou), r.apIda?1:0, r.apVolta?1:0
  ].join(','));
  return head.join(',')+'\n'+lines.join('\n');
}
function downloadCSV(area){
  const db=getData(); const rows=db[area]||[];
  const blob=new Blob([toCSV(rows)],{type:'text/csv;charset=utf-8;'});
  const a=document.createElement('a');
  a.href=URL.createObjectURL(blob);
  a.download=`checklist_${area.toLowerCase()}.csv`;
  document.body.appendChild(a); a.click(); a.remove();
}
function exportAreaCSV(){ const area=$('areaSelect').value; downloadCSV(area); }
function exportMyCSV(){ const u=getUser(); if(!u) return; downloadCSV(u.role); }

/* ===== Comercial — Propostas ===== */
function enviarProposta(){
  const campos = [
    "pIni","pVend","pShop","pTotalLojas","pCRM","pVagas","pAdm","pRank","pExec","pTel","pEnd",
    "pMontNoite","pDesmNoite","pDias","pFeriados","pTema","pM2","pLic","pPisos","pValor","pPe",
    "pPracaProp","pQtdPracas","pConc","pBilheteConc","pTemaAnt","pRefParque","pPeriodo","pAluguel",
    "pFaturamento","pCP1","pCP2","pCP3","pCP4","pConsider","pExig","pCond","pGold","pComissao"
  ];
  const data = {}; campos.forEach(id => data[id] = $(id).value);
  const arr = getProps(); const user = getUser();
  arr.push({
    id: Date.now(),
    criadoPor: user?.name,
    dados: data,
    status: "Pendente",
    aprovadoPor: null,
    observacao: ""
  });
  setProps(arr);
  alert("Proposta enviada à diretoria!");
  campos.forEach(id=>$(id).value="");
  renderMyPropostas();
}
function renderComercial(){
  const tabs = document.querySelectorAll("#pageComercial .tab");
  tabs.forEach(btn=>{
    btn.onclick = ()=>{
      tabs.forEach(b=>b.classList.remove("active"));
      btn.classList.add("active");
      const t=btn.dataset.tab;
      $("panel-prop-new").classList.toggle("hide",t!=="prop-new");
      $("panel-prop-my").classList.toggle("hide",t!=="prop-my");
      if(t==="prop-my") renderMyPropostas();
    };
  });
  renderMyPropostas();
}
function renderMyPropostas(){
  const arr=getProps(); const user=getUser();
  const my=arr.filter(p=>p.criadoPor===user?.name);
  if(!my.length){ $("myPropsWrap").innerHTML="<p>Nenhuma proposta enviada.</p>"; return; }
  $("myPropsWrap").innerHTML=my.map(p=>`
    <div class="card" style="margin-bottom:10px">
      <b>Shopping:</b> ${esc(p.dados.pShop||"-")}<br>
      <b>Status:</b> ${p.status} ${p.aprovadoPor?`por ${p.aprovadoPor}`:""}<br>
      <b>Obs.:</b> ${esc(p.observacao||"-")}
    </div>
  `).join("");
}

/* ===== Diretoria — Visualizar + Aprovar/Negar (PIN) ===== */
function renderDiretoria(){
  const arr=getProps();
  const wrap=$("dirPropsWrap");
  $("dirPropDetail").innerHTML="";
  if(!arr.length){ wrap.innerHTML="<p>Sem propostas enviadas.</p>"; return; }
  wrap.innerHTML=arr.map(p=>`
    <div class="card" style="margin-bottom:10px">
      <b>${esc(p.dados.pShop || 'Sem nome')}</b><br>
      <small>${p.status}${p.aprovadoPor?` — ${p.aprovadoPor}`:""}</small><br>
      <button class="btn sm" onclick="verProposta(${p.id})">Ver Detalhes</button>
    </div>
  `).join("");
}
function verProposta(id){
  const arr=getProps(); const p=arr.find(x=>x.id===id); if(!p) return;
  const d=p.dados;
  let html=`<div class="card"><h3>Proposta #${id} — ${esc(d.pShop||d.pShop||'')}</h3><div style="overflow:auto;"><table>`;
  for(const [k,v] of Object.entries(d)){ html+=`<tr><th style="text-align:left">${esc(k)}</th><td>${esc(v)}</td></tr>`; }
  html+=`</table></div>
    <p><b>Status:</b> ${p.status}</p>
    <p><b>Aprovado por:</b> ${esc(p.aprovadoPor||"-")}</p>
    <p><b>Observação:</b> ${esc(p.observacao||"-")}</p>
    <div class="row" style="margin-top:10px">
      <button class="btn ok" onclick="aprovar(${id})">Aprovar</button>
      <button class="btn danger" onclick="negar(${id})">Negar</button>
      <button class="btn ghost" onclick="renderDiretoria()">Voltar</button>
    </div></div>`;
  $("dirPropDetail").innerHTML=html;
  $("dirPropsWrap").innerHTML="";
}
function aprovar(id){
  const pin=prompt("Digite seu PIN de aprovação:");
  if(!pin) return;
  const aprovs=getApprovers(); const dir=aprovs.find(a=>a.pin===pin);
  if(!dir){ alert("PIN inválido."); return; }
  const arr=getProps(); const p=arr.find(x=>x.id===id);
  p.status="Aprovado"; p.aprovadoPor=dir.name; p.observacao="";
  setProps(arr);
  alert("Proposta aprovada!");
  renderDiretoria();
}
function negar(id){
  const pin=prompt("PIN do diretor:");
  if(!pin) return;
  const aprovs=getApprovers(); const dir=aprovs.find(a=>a.pin===pin);
  if(!dir){ alert("PIN inválido."); return; }
  const obs=prompt("Motivo da negativa:");
  const arr=getProps(); const p=arr.find(x=>x.id===id);
  p.status="Negado"; p.aprovadoPor=dir.name; p.observacao=obs||"";
  setProps(arr);
  alert("Proposta negada.");
  renderDiretoria();
}

/* ===== CSV helpers ===== */
function toCSV(rows){
  const head=['ITEM','DESCRICAO','ANTIGO','NOVO','ENVIAR','SOBRA','VOLTOU','FALTOU','AP_IDA','AP_VOLTA'];
  const lines=rows.map(r=>[
    csvEsc(r.item), csvEsc(r.desc||''), num(r.antigo), num(r.novo), num(r.enviar), num(r.sobra),
    num(r.voltou), num(r.faltou), r.apIda?1:0, r.apVolta?1:0
  ].join(','));
  return head.join(',')+'\n'+lines.join('\n');
}
function exportAreaCSV(){ const area=$('areaSelect').value; downloadCSV(area); }
function exportMyCSV(){ const u=getUser(); if(!u) return; downloadCSV(u.role); }
function downloadCSV(area){
  const db=getData(); const rows=db[area]||[];
  const blob=new Blob([toCSV(rows)],{type:'text/csv;charset=utf-8;'});
  const a=document.createElement('a');
  a.href=URL.createObjectURL(blob);
  a.download=`checklist_${area.toLowerCase()}.csv`;
  document.body.appendChild(a); a.click(); a.remove();
}

/* ===== Força exibir login se algo travar ===== */
setTimeout(() => {
  try {
    const hasSession = !!localStorage.getItem('sis_session');
    const loginHidden = document.getElementById('pageLogin')?.classList.contains('hide');
    const somePageVisible = ['pageAdmin','pageComercial','pageDiretoria','pageArea']
      .some(id => !document.getElementById(id)?.classList.contains('hide'));
    if (!hasSession && (loginHidden || !somePageVisible)) {
      ['pageAdmin','pageComercial','pageDiretoria','pageArea'].forEach(id=>document.getElementById(id)?.classList.add('hide'));
      document.getElementById('pageLogin')?.classList.remove('hide');
    }
  } catch(e){ console.warn('force-login error', e); }
}, 3000);

window.addEventListener('error', (ev)=>{
  console.error('JS error:', ev.message, ev.error);
});
</script>
</html>
