<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>SIS — Sistema Interno Safári</title>
<style>
/* ===================== PARTE 1/3 — ESTILOS (CSS) ===================== */
:root{
  --bg-1:#060a18; --bg-2:#0b1430; --bg-3:#0a1024; --panel:#0d1734cc;
  --ink:#f2f6fb; --muted:#a9b5cc; --line:#1d2a49;
  --brand:#57c8ff; --brand2:#2be3e3; --ok:#22c55e; --warn:#f59e0b; --danger:#ef4444;
  --radius:18px; --shadow:0 24px 60px rgba(0,0,0,.45), inset 0 1px 0 rgba(255,255,255,.04);
}
*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0; color:var(--ink);
  font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Ubuntu;
  background: radial-gradient(1000px 800px at 20% -10%, #153b6e 0%, transparent 60%),
              radial-gradient(900px 650px at 90% 0%, #0f2f54 0%, transparent 55%),
              linear-gradient(180deg,var(--bg-2) 0%, var(--bg-1) 55%, var(--bg-3) 100%);
}
.topbar{position:sticky;top:0;z-index:10;display:flex;justify-content:space-between;align-items:center;padding:14px 18px;border-bottom:1px solid var(--line);background:#0b1430b3;backdrop-filter:saturate(120%) blur(8px)}
.brand{display:flex;align-items:center;gap:10px;font-weight:800}
.logo{height:40px}
.btn{background:linear-gradient(180deg,var(--brand),#38b7ff);color:#05141f;border:none;padding:12px 16px;border-radius:14px;font-weight:800;cursor:pointer;transition:.06s transform,.2s box-shadow}
.btn:hover{transform:translateY(-1px);box-shadow:0 16px 28px rgba(92,200,255,.3)}
.btn.ghost{background:transparent;border:1px solid var(--line);color:var(--ink)}
.btn.ok{background:linear-gradient(180deg,#38e07f,#20c760);color:#05140b}
.btn.warn{background:linear-gradient(180deg,#ffc34d,#ffad33)}
.btn.danger{background:linear-gradient(180deg,#ff6b6b,#ff4747)}
.btn.xs{padding:6px 10px;border-radius:10px;font-size:12px}
.btn.sm{padding:8px 12px;border-radius:12px;font-size:13px}
.container{max-width:1200px;margin:28px auto;padding:0 16px}
.row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
.muted{color:var(--muted)} .s{font-size:12px}
.card{background:var(--panel);border:1px solid rgba(255,255,255,.06);border-radius:18px;box-shadow:var(--shadow);backdrop-filter: blur(12px);padding:20px}
.hide{display:none!important}

.field{display:grid;gap:6px}
.field input,.field select,.field textarea{padding:12px 14px;border-radius:14px;border:1px solid rgba(255,255,255,.12);background:rgba(6,18,36,.78);color:var(--ink);outline:none}
.field input:focus,.field select:focus,.field textarea:focus{border-color:rgba(92,200,255,.7);box-shadow:0 0 0 6px rgba(92,200,255,.12)}
.grid-2{display:grid;grid-template-columns:1fr 1fr;gap:14px}
.grid-3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:14px}
@media(max-width:900px){.grid-2,.grid-3{grid-template-columns:1fr}}

.tabs{display:flex;gap:12px;margin-bottom:16px;flex-wrap:wrap}
.tab{background:transparent;color:#fff;border:none;font-weight:800;padding:10px 14px;border-radius:12px;cursor:pointer;opacity:.9}
.tab:hover{opacity:1;transform:translateY(-1px)}
.tab.active{color:var(--brand);box-shadow:0 2px 0 0 var(--brand) inset}

table{width:100%;border-collapse:collapse}
th,td{padding:10px;border-bottom:1px solid var(--line);vertical-align:middle}
thead th{font-size:12px;letter-spacing:.35px;color:#cfe2ff;background:linear-gradient(180deg,rgba(255,255,255,.04),rgba(255,255,255,.02));position:sticky;top:0;z-index:1}
tbody tr:hover{background:rgba(255,255,255,.03)}
td input[type="number"],td input[type="text"]{width:100%;max-width:140px;background:rgba(8,18,36,.7);border:1px solid rgba(255,255,255,.12);color:var(--ink);border-radius:12px;padding:8px 10px}
td input[type="number"]:focus,td input[type="text"]:focus{border-color:rgba(92,200,255,.6)}

.progress{height:12px;background:#0b1220;border:1px solid var(--line);border-radius:10px;overflow:hidden}
.bar{height:100%;background:linear-gradient(90deg,var(--brand),var(--brand2))}
.kpi{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px}
.pill{padding:6px 10px;border-radius:999px;border:1px solid var(--line);background:rgba(6,18,36,.55);font-size:12px}

/* Login bonito */
#pageLogin{position:relative;overflow:hidden;min-height:calc(100vh - 64px);display:grid;place-items:center;padding:38px}
.login-wrap{position:relative;width:min(820px,92%);padding:28px;border-radius:24px;background:rgba(7,15,30,.62);border:1px solid rgba(255,255,255,.08);box-shadow:0 30px 80px rgba(0,0,0,.55);backdrop-filter: blur(16px)}
.login-head{display:flex;flex-direction:column;align-items:center;gap:8px;margin-bottom:14px}
.logo-lg{height:94px;filter:drop-shadow(0 10px 18px rgba(0,0,0,.45));animation:floatY 4s ease-in-out infinite}
.title-sis{font-size:62px;font-weight:900;letter-spacing:2px;background:linear-gradient(90deg,var(--brand),#7ef9ff);-webkit-background-clip:text;-webkit-text-fill-color:transparent;text-shadow:0 0 20px rgba(87,200,255,.4);animation:glowPulse 3s ease-in-out infinite}
.subtitle{font-size:18px;color:var(--muted);margin-top:-8px}
.signature{position:fixed;right:16px;bottom:12px;font-size:12px;color:var(--muted);opacity:.9;pointer-events:none}
.signature b{color:#cfe2ff}
@keyframes glowPulse{0%,100%{text-shadow:0 0 18px rgba(87,200,255,.4)}50%{text-shadow:0 0 36px rgba(87,200,255,.9)}}
@keyframes floatY{0%,100%{transform:translateY(0)}50%{transform:translateY(-6px)}}
.blob{position:absolute;filter:blur(50px);opacity:.65;z-index:-1;animation:blob 18s ease-in-out infinite alternate}
.blob.one{width:460px;height:460px;top:-120px;left:-120px;background:radial-gradient(closest-side,#2bd4e3,transparent)}
.blob.two{width:520px;height:520px;bottom:-200px;right:-160px;background:radial-gradient(closest-side,#4fb6ff,transparent);animation-delay:2s}
.blob.three{width:420px;height:420px;bottom:10%;left:15%;background:radial-gradient(closest-side,#2f5cf0,transparent);animation-delay:4s}
@keyframes blob{0%{transform:translate(0,0) scale(1)}50%{transform:translate(20px,-30px) scale(1.1)}100%{transform:translate(-20px,20px) scale(1)}}
.twinkle{position:absolute;inset:0;pointer-events:none}
.dot{position:absolute;width:3px;height:3px;border-radius:50%;background:#c7e7ff66;animation:twinkle 3.6s linear infinite}
@keyframes twinkle{0%{opacity:0}10%{opacity:1}50%{opacity:.2}90%{opacity:1}100%{opacity:0}}
</style>
</head>
<body>

<header class="topbar">
  <div class="brand">
    <img src="logo.png" class="logo" onerror="this.style.display='none'">
    <span>SIS — Sistema Interno Safári</span>
  </div>
  <div id="userNav" class="row hide">
    <span>Olá, <strong id="userName"></strong> — <span id="userRole"></span></span>
    <button class="btn ghost" onclick="logout()">Sair</button>
  </div>
</header>

<main>
  <!-- ===================== LOGIN ===================== -->
  <section id="pageLogin">
    <div class="blob one"></div><div class="blob two"></div><div class="blob three"></div>
    <div class="twinkle" id="twinkle"></div>
    <div class="login-wrap">
      <div class="login-head">
        <img src="logo.png" class="logo-lg" onerror="this.style.display='none'">
        <div class="title-sis">SIS</div>
        <div class="subtitle">Sistema Interno Safári</div>
      </div>
      <form class="grid-2" onsubmit="return doLogin(event)">
        <div class="field" style="grid-column:1/-1">
          <label>Usuário</label><input id="inUser" placeholder="ex.: admin, comercial, projetos…" required>
        </div>
        <div class="field" style="grid-column:1/-1">
          <label>Senha</label><input id="inPass" type="password" placeholder="sua senha" required>
        </div>
        <div class="row" style="grid-column:1/-1;justify-content:space-between">
          <div class="row" style="gap:8px">
            <button class="btn" type="submit">Entrar</button>
            <button class="btn ghost" type="button" onclick="resetSession()">Resetar sessão</button>
          </div>
        </div>
      </form>
      <div class="signature">Desenvolvido por <b>Gustavo Morino</b> e <b>Felipe Forato</b></div>
    </div>
  </section>

  <!-- ===================== ADMIN ===================== -->
  <section id="pageAdmin" class="container hide">
    <div class="tabs" id="adminTabs">
      <button class="tab active" data-tab="dash">Dashboard</button>
      <button class="tab" data-tab="area">Visualizar área</button>
      <button class="tab" data-tab="access">Acessos</button>
    </div>

    <div id="panel-dash" class="panel">
      <div class="card"><h2 style="margin:6px 0 14px">Progresso por área</h2><div id="dashCards" class="row"></div></div>
    </div>

    <div id="panel-area" class="panel hide">
      <div class="card">
        <div class="row" style="justify-content:space-between">
          <h2 style="margin:6px 0">Checklist da área</h2>
          <div class="row">
            <select id="areaSelect" class="field" style="padding:8px 10px;border-radius:10px;border:1px solid var(--line);background:rgba(6,18,36,.75);color:var(--ink)"></select>
            <button class="btn ghost" onclick="exportAreaCSV()">Exportar CSV</button>
          </div>
        </div>
        <div id="areaWrap"></div>
      </div>
    </div>

    <div id="panel-access" class="panel hide">
      <div class="grid-2">
        <div class="card">
          <h2 style="margin:6px 0 12px">Criar novo acesso</h2>
          <div class="form">
            <div class="field"><label>Nome</label><input id="accName"></div>
            <div class="field"><label>Usuário (login)</label><input id="accUser"></div>
            <div class="field"><label>Senha</label><input id="accPass"></div>
            <div class="field"><label>Área/Perfil</label><select id="accRole"></select></div>
            <div class="row" style="justify-content:flex-end"><button class="btn sm" onclick="createAccess()">Criar acesso</button></div>
            <p class="muted s">Obs.: O usuário criado verá apenas o módulo/área escolhida.</p>
          </div>
        </div>

        <div class="card">
          <h2 style="margin:6px 0 12px">Usuários cadastrados</h2>
          <div id="userList"></div>
          <div id="dirApproversBox" class="card" style="margin-top:14px"></div>

          <!-- Importador de REFERÊNCIAS (Shopping/UF + Temas) -->
          <div class="card" style="margin-top:14px">
            <h2 style="margin:6px 0 12px">Referências — Shopping & Temas</h2>
            <div class="grid-2">
              <div class="field">
                <label>Colar “SHOPPING<TAB>UF” (uma linha por shopping)</label>
                <textarea id="refShops" rows="6" placeholder="CANOAS SHOPPING\tRS&#10;IGUATEMI PORTO ALEGRE\tRS"></textarea>
              </div>
              <div class="field">
                <label>Colar TEMAS (um por linha)</label>
                <textarea id="refTemas" rows="6" placeholder="ARENA COPA DO MUNDO&#10;TRAMPOLIM PARK"></textarea>
              </div>
            </div>
            <div class="row" style="justify-content:flex-end">
              <button class="btn sm" onclick="importRefs()">Importar/Atualizar</button>
              <button class="btn sm ghost" onclick="clearRefs()">Limpar referências</button>
            </div>
            <p class="s muted">Essas listas alimentam os campos com busca nas solicitações do Comercial.</p>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- ===================== DIRETORIA (Propostas anteriores) ===================== -->
  <section id="pageDiretoria" class="container hide">
    <div class="card">
      <h2 style="margin:6px 0 12px">Propostas — Aprovação</h2>
      <div id="dirPropsWrap"></div>
      <div id="dirPropDetail"></div>
    </div>
  </section>

  <!-- ===================== PROJETOS — Recebe solicitações do Comercial ===================== -->
  <section id="pageProjetos" class="container hide">
    <div class="card">
      <h2 style="margin:6px 0 12px">Solicitações Recebidas (Comercial → Projetos)</h2>
      <div id="projList"></div>
      <div id="projDetail"></div>
    </div>
  </section>

  <!-- ===================== COMERCIAL ===================== -->
  <section id="pageComercial" class="container hide">
    <div class="tabs">
      <button class="tab active" data-tab="prop-new">Abrir Proposta</button>
      <button class="tab" data-tab="prop-my">Minhas Propostas</button>
      <button class="tab" data-tab="previa-new">Solicitar Prévia</button>
      <button class="tab" data-tab="proj-new">Solicitar Projeto</button>
      <button class="tab" data-tab="req-my">Minhas Solicitações</button>
    </div>

    <!-- Propostas (já existente) -->
    <div id="panel-prop-new" class="panel">
      <div class="card">
        <h2 style="margin:6px 0 12px">Abrir Proposta</h2>
        <div class="grid-2">
          <div class="field"><label>Início da negociação</label><input id="pIni" type="date" required></div>
          <div class="field"><label>Vendedor Safári</label><input id="pVend" placeholder="Seu nome" required></div>
        </div>

        <h3 style="margin:12px 0 6px">Dados do Shopping</h3>
        <div class="grid-2">
          <div class="field"><label>Nome do Shopping</label><input id="pShop" placeholder="conforme Google" required></div>
          <div class="field"><label>Total de Lojas</label><input id="pTotalLojas" type="number" min="0" placeholder="Ex.: 180" required></div>
          <div class="field"><label>Nº oportunidade CRM</label><input id="pCRM" required></div>
          <div class="field"><label>Vagas de Estacionamento e Salas de cinema</label><input id="pVagas" required></div>
          <div class="field"><label>Administração</label><input id="pAdm" required></div>
          <div class="field"><label>Ranking do Google (comparado)</label><input id="pRank" required></div>
          <div class="field"><label>Executivo do Shopping (sobrenome)</label><input id="pExec" required></div>
          <div class="field"><label>Telefones</label><input id="pTel" required></div>
          <div class="field grid-2" style="grid-column:1/-1"><label>Endereço completo</label><input id="pEnd" required></div>
        </div>

        <h3 style="margin:12px 0 6px">Proposta do Shopping</h3>
        <div class="grid-2">
          <div class="field"><label>Noite da montagem</label><input id="pMontNoite" required></div>
          <div class="field"><label>Noite da desmontagem</label><input id="pDesmNoite" required></div>
          <div class="field"><label>Períodos em dias</label><input id="pDias" type="number" min="0" required></div>
          <div class="field"><label>Feriados no período</label><input id="pFeriados" placeholder="feriado.com.br" required></div>
          <div class="field"><label>Tema</label><input id="pTema" required></div>
          <div class="field"><label>Metragem da praça (m²)</label><input id="pM2" type="number" min="0" required></div>
          <div class="field"><label>Licenciado? (enviar termo)</label><input id="pLic" required></div>
          <div class="field"><label>Quantos pisos</label><input id="pPisos" type="number" min="0" required></div>
          <div class="field"><label>Valor</label><input id="pValor" required></div>
          <div class="field"><label>Pé direito</label><input id="pPe" required></div>
          <div class="field"><label>Qual praça propõe?</label><input id="pPracaProp" required></div>
          <div class="field"><label>Qtd de praças no shopping</label><input id="pQtdPracas" type="number" min="0" required></div>
          <div class="field"><label>Concorrência no período</label><input id="pConc" required></div>
          <div class="field"><label>Bilheteria do concorrente</label><input id="pBilheteConc" required></div>
        </div>

        <h3 style="margin:12px 0 6px">Referências de Faturamento</h3>
        <div class="grid-2">
          <div class="field"><label>Se JÁ operamos, qual foi o tema?</label><input id="pTemaAnt" required></div>
          <div class="field"><label>Se NÃO operamos, esses valores se referem a qual parque?</label><input id="pRefParque" required></div>
          <div class="field"><label>Período</label><input id="pPeriodo" required></div>
          <div class="field"><label>Aluguel da época (TOTAL e PROP/MÊS)</label><input id="pAluguel" required></div>
          <div class="field grid-2" style="grid-column:1/-1"><label>Faturamento total do período (e proporcional)</label><input id="pFaturamento" required></div>
        </div>

        <h3 style="margin:12px 0 6px">Negociação com o Shopping</h3>
        <div class="grid-2">
          <div class="field"><label>1ª contraproposta (data e análise)</label><input id="pCP1" required></div>
          <div class="field"><label>2ª contraproposta (data e análise)</label><input id="pCP2" required></div>
          <div class="field"><label>3ª contraproposta (data e análise)</label><input id="pCP3" required></div>
          <div class="field"><label>4ª contraproposta (data e análise)</label><input id="pCP4" required></div>
        </div>
        <div class="grid-2">
          <div class="field"><label>Valor e considerações finais</label><textarea id="pConsider" rows="3" required></textarea></div>
          <div class="field"><label>Exigências do shopping</label><textarea id="pExig" rows="3" placeholder="Alvará? Cor de bolinhas?" required></textarea></div>
        </div>

        <h3 style="margin:12px 0 6px">Condições para aprovação</h3>
        <div class="grid-3">
          <div class="field"><label>Condições</label><input id="pCond" required></div>
          <div class="field"><label>É uma negociação GOLD?</label><select id="pGold"><option>Não</option><option>Sim</option></select></div>
          <div class="field"><label>Comissão (qtd e valor)</label><input id="pComissao" required></div>
        </div>

        <div class="row" style="justify-content:flex-end;margin-top:10px">
          <button class="btn" onclick="enviarProposta()">Enviar para Diretoria</button>
        </div>
      </div>
    </div>

    <div id="panel-prop-my" class="panel hide">
      <div class="card">
        <h2 style="margin:6px 0 12px">Minhas Propostas Enviadas</h2>
        <div id="myPropsWrap"></div>
      </div>
    </div>

    <!-- NOVO: Solicitar PRÉVIA -->
    <div id="panel-previa-new" class="panel hide">
      <div class="card">
        <h2 style="margin:6px 0 12px">Solicitar Prévia</h2>

        <div class="grid-3">
          <div class="field"><label>Tipo de Solicitação</label>
            <select id="prevTipo" required>
              <option value="PREVIA">Pré fechar contrato: PRÉVIA</option>
            </select>
          </div>
          <div class="field"><label>Apresentação (Prévia)</label>
            <select id="prevApres" required>
              <option value="">Selecione…</option>
              <option value="SIMPLES">PRÉVIA SIMPLES</option>
              <option value="RENDERIZADA">PRÉVIA RENDERIZADA</option>
            </select>
          </div>
          <div class="field"><label>Vendedor responsável</label><input id="prevVendedor" required></div>
        </div>

        <h3 style="margin:12px 0 6px">Dados do Evento</h3>
        <div class="grid-3">
          <div class="field"><label>Shopping</label>
            <input id="prevShop" placeholder="digite para buscar…" list="dlShops" required>
          </div>
          <div class="field"><label>UF</label><input id="prevUF" placeholder="preenchido pela lista" required></div>
          <div class="field"><label>Nível de exigência</label>
            <select id="prevExig" required>
              <option value="">Selecione…</option>
              <option>baixo</option><option>médio</option><option>alta</option>
            </select>
          </div>
          <div class="field"><label>Cidade/UF (texto)</label><input id="prevCidade" placeholder="ex.: Canoas - RS" required></div>
          <div class="field"><label>Tema</label>
            <input id="prevTema" placeholder="digite para buscar…" list="dlTemas" required>
          </div>
          <div class="field"><label>Praça de eventos (nome)</label><input id="prevPraca" required></div>
          <div class="field"><label>Metragem da praça (m²)</label><input id="prevM2" type="number" min="0" required></div>
        </div>

        <div class="row" style="justify-content:flex-end;margin-top:10px">
          <button class="btn" onclick="enviarSolicitacao('PREVIA')">Enviar para Projetos</button>
        </div>
      </div>
    </div>

    <!-- NOVO: Solicitar PROJETO -->
    <div id="panel-proj-new" class="panel hide">
      <div class="card">
        <h2 style="margin:6px 0 12px">Solicitar Projeto</h2>

        <div class="grid-3">
          <div class="field"><label>Tipo de Solicitação</label>
            <select id="projTipo" required>
              <option value="PROJETO">Pós fechar contrato: PROJETO</option>
            </select>
          </div>
          <div class="field"><label>Apresentação (se Prévia)</label>
            <select id="projApres" disabled>
              <option>— (não aplicável para PROJETO) —</option>
            </select>
          </div>
          <div class="field"><label>Vendedor responsável</label><input id="projVendedor" required></div>
        </div>

        <h3 style="margin:12px 0 6px">Dados do Evento</h3>
        <div class="grid-3">
          <div class="field"><label>Shopping</label>
            <input id="projShop" placeholder="digite para buscar…" list="dlShops" required>
          </div>
          <div class="field"><label>UF</label><input id="projUF" placeholder="preenchido pela lista" required></div>
          <div class="field"><label>Cidade/UF (texto)</label><input id="projCidade" placeholder="ex.: Canoas - RS" required></div>
          <div class="field"><label>Nome da praça</label><input id="projPraca" required></div>
          <div class="field"><label>Metragem (m²)</label><input id="projM2" type="number" min="0" required></div>
          <div class="field"><label>Tema</label>
            <input id="projTema" placeholder="digite para buscar…" list="dlTemas" required>
          </div>
          <div class="field"><label>Período — início</label><input id="projIni" type="date" required></div>
          <div class="field"><label>Período — fim</label><input id="projFim" type="date" required></div>
          <div class="field"><label>Montagem — data/obs</label><input id="projMont" placeholder="01/06/2026 (após 22h)" required></div>
          <div class="field"><label>Desmontagem — data/obs</label><input id="projDesm" placeholder="31/07/2026 (após 22h)" required></div>
          <div class="field"><label>Razão social</label>
            <select id="projRazao" required><option value="">Selecione…</option><option>DIVERSÃO</option><option selected>EVENTOS</option></select>
          </div>
          <div class="field"><label>Loja de referência (próx. praça)</label><input id="projLojaRef" required></div>
        </div>

        <h3 style="margin:12px 0 6px">Contatos do Shopping</h3>
        <div class="grid-3">
          <div class="field"><label>Contato comercial 1 — Nome</label><input id="projC1Nome" required></div>
          <div class="field"><label>Contato comercial 1 — E-mail</label><input id="projC1Mail" type="email" required></div>
          <div class="field"><label>Contato comercial 1 — Fone</label><input id="projC1Fone" required></div>
          <div class="field"><label>Contato comercial 2 — Nome</label><input id="projC2Nome" required></div>
          <div class="field"><label>Contato comercial 2 — E-mail</label><input id="projC2Mail" type="email" required></div>
          <div class="field"><label>Contato comercial 2 — Fone</label><input id="projC2Fone" required></div>
        </div>

        <h3 style="margin:12px 0 6px">Documentação Solicitada</h3>
        <div class="grid-3">
          <!-- todos obrigatórios (sim/não) -->
          ${['AVCB','ALVARÁ','PROJETO ARQUITETÔNICO','PROJETO ELÉTRICO','ART DE PROJETO','ART DE MONTAGEM','SEGURO DE RESPONSABILIDADE','PROJETO DE BOMBEIRO','PROJETO ESTRUTURAL','APROVAÇÃO POR PORTAL','APROVAÇÃO POR E-MAIL']
            .map((lab,i)=>`
              <div class="field">
                <label>${lab}</label>
                <select id="doc_${i}" required><option value="">Selecione…</option><option>SIM</option><option>NÃO</option></select>
              </div>`).join('')}
        </div>

        <div class="row" style="justify-content:flex-end;margin-top:10px">
          <button class="btn" onclick="enviarSolicitacao('PROJETO')">Enviar para Projetos</button>
        </div>
      </div>
    </div>

    <!-- Minhas solicitações (Prévia/Projeto) -->
    <div id="panel-req-my" class="panel hide">
      <div class="card">
        <h2 style="margin:6px 0 12px">Minhas Solicitações</h2>
        <div id="myReqsWrap"></div>
      </div>
    </div>
  </section>

  <!-- datalists para auto-completar -->
  <datalist id="dlShops"></datalist>
  <datalist id="dlTemas"></datalist>
</main>

<!-- ===================== PARTE 2/3 — LÓGICA (JS) ===================== -->
<script>
/* -------- util -------- */
const $ = (id)=>document.getElementById(id);
const show = (id)=>$(id)?.classList.remove('hide');
const hide = (id)=>$(id)?.classList.add('hide');
const esc = (s)=>String(s??'').replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
const num = (v)=>Number(v)||0;

/* estrelas no login */
(function(){ const wrap=$('twinkle'); if(!wrap) return; let h=''; for(let i=0;i<80;i++){h+=`<span class="dot" style="left:${Math.random()*100}%;top:${Math.random()*100}%;animation-duration:${(2+Math.random()*3).toFixed(2)}s;animation-delay:${(Math.random()*3).toFixed(2)}s"></span>`} wrap.innerHTML=h; })();

/* -------- chaves storage -------- */
const KEY_SESSION='sis_session';
const KEY_USERS='sis_users';
const KEY_DATA='sis_checklists';                 // checklists (já existente)
const KEY_PROPS='sis_propostas';                // propostas (Diretoria)
const KEY_REQS='sis_reqs_proj';                 // NOVO: solicitações (Comercial→Projetos)
const KEY_REF_SHOPS='sis_ref_shops';            // NOVO: lista de shoppings [{nome,uf}]
const KEY_REF_TEMAS='sis_ref_temas';            // NOVO: lista de temas [string]
const KEY_DIR_APPROVERS='sis_dir_approvers';

const ROLES={ADMIN:'ADMIN',COMERCIAL:'COMERCIAL',DIRETORIA:'DIRETORIA',PROJETOS:'PROJETOS',ESTOQUE:'ESTOQUE',FABRICACAO:'FABRICACAO',PRODUCAO:'PRODUCAO',MARKETING:'MARKETING',GRAFICA:'GRAFICA',LOGISTICA:'LOGISTICA'};

/* -------- sessão/usuários seed -------- */
function getUser(){ try{return JSON.parse(localStorage.getItem(KEY_SESSION))}catch{return null} }
function setUser(u){ localStorage.setItem(KEY_SESSION, JSON.stringify(u)) }
function logout(){ localStorage.removeItem(KEY_SESSION); initUI(); }
function resetSession(){ localStorage.clear(); location.reload(); }

const SEED_USERS=[
  {name:'Administrador', username:'admin', password:'123456', role:ROLES.ADMIN},
  {name:'Comercial', username:'comercial', password:'123', role:ROLES.COMERCIAL},
  {name:'Projetos', username:'projetos', password:'123', role:ROLES.PROJETOS},
  {name:'Diretoria', username:'diretoria', password:'0000', role:ROLES.DIRETORIA},
  {name:'Estoque', username:'estoque', password:'123', role:ROLES.ESTOQUE},
  {name:'Fabricação', username:'fabricacao', password:'123', role:ROLES.FABRICACAO},
  {name:'Produção', username:'producao', password:'123', role:ROLES.PRODUCAO},
  {name:'Marketing', username:'marketing', password:'123', role:ROLES.MARKETING},
  {name:'Gráfica', username:'grafica', password:'123', role:ROLES.GRAFICA},
  {name:'Logística', username:'logistica', password:'123', role:ROLES.LOGISTICA},
];
function getUsers(){
  try{const raw=localStorage.getItem(KEY_USERS); if(raw){const arr=JSON.parse(raw); if(Array.isArray(arr)) return seedUsers(arr);}}
  catch{}
  localStorage.setItem(KEY_USERS, JSON.stringify(SEED_USERS));
  return JSON.parse(localStorage.getItem(KEY_USERS));
}
function setUsers(list){ localStorage.setItem(KEY_USERS, JSON.stringify(list)) }
function seedUsers(arr){
  const map=new Map(arr.map(u=>[u.username.toLowerCase(),u]));
  SEED_USERS.forEach(s=>{ if(!map.has(s.username.toLowerCase())) arr.push(s); });
  localStorage.setItem(KEY_USERS, JSON.stringify(arr));
  return arr;
}

/* -------- aprovadores diretoria (já existia) -------- */
const SEED_APPROVERS=[{name:'Diretor A',pin:'7410'},{name:'Diretor B',pin:'8520'},{name:'Diretor C',pin:'9630'},{name:'Diretor D',pin:'1590'}];
function getApprovers(){ try{const raw=localStorage.getItem(KEY_DIR_APPROVERS); if(raw){const a=JSON.parse(raw); if(Array.isArray(a)&&a.length)return a;}}catch{} localStorage.setItem(KEY_DIR_APPROVERS, JSON.stringify(SEED_APPROVERS)); return JSON.parse(localStorage.getItem(KEY_DIR_APPROVERS));}
function setApprovers(list){ localStorage.setItem(KEY_DIR_APPROVERS, JSON.stringify(list)) }

/* -------- referências: Shopping & Temas -------- */
function parseShops(text){
  const out=[]; (text||'').split(/\r?\n/).forEach(line=>{
    line=line.trim(); if(!line) return;
    const parts=line.split(/\t| {2,}/); // tab ou 2+ espaços
    const nome=parts[0]?.trim(); const uf=(parts[1]||'').trim().slice(0,2).toUpperCase();
    if(nome) out.push({nome, uf: uf||''});
  });
  return out;
}
function parseTemas(text){ return (text||'').split(/\r?\n/).map(s=>s.trim()).filter(Boolean); }
function getRefShops(){ try{const j=JSON.parse(localStorage.getItem(KEY_REF_SHOPS)); if(Array.isArray(j)) return j;}catch{} return []; }
function getRefTemas(){ try{const j=JSON.parse(localStorage.getItem(KEY_REF_TEMAS)); if(Array.isArray(j)) return j;}catch{} return []; }
function importRefs(){
  const shops=parseShops($('refShops').value);
  const temas=parseTemas($('refTemas').value);
  if(!shops.length && !temas.length){ alert('Cole ao menos uma lista.'); return; }
  if(shops.length) localStorage.setItem(KEY_REF_SHOPS, JSON.stringify(shops));
  if(temas.length) localStorage.setItem(KEY_REF_TEMAS, JSON.stringify(temas));
  fillDataLists();
  alert('Referências atualizadas!');
}
function clearRefs(){ localStorage.removeItem(KEY_REF_SHOPS); localStorage.removeItem(KEY_REF_TEMAS); fillDataLists(); alert('Listas limpas.'); }
function fillDataLists(){
  const dlS=$('dlShops'), dlT=$('dlTemas');
  const shops=getRefShops(); const temas=getRefTemas();
  dlS.innerHTML=shops.map(s=>`<option value="${esc(s.nome)}">${esc(s.uf||'')}</option>`).join('');
  dlT.innerHTML=temas.map(t=>`<option value="${esc(t)}">`).join('');
}
/* UF auto-preenchimento quando escolher shopping */
['prevShop','projShop'].forEach(id=>{
  const input = ()=> $(id)?.addEventListener('change',()=>{
    const v=$(id).value.trim().toLowerCase();
    const s=getRefShops().find(x=>x.nome.toLowerCase()===v);
    if(!s) return;
    if(id==='prevShop') $('prevUF').value=s.uf||'';
    if(id==='projShop') $('projUF').value=s.uf||'';
  });
  document.addEventListener('DOMContentLoaded', input);
});

/* -------- dados existentes (checklists/propostas) -------- */
function getData(){ try{const v=JSON.parse(localStorage.getItem(KEY_DATA)); if(v&&typeof v==='object') return v;}catch{} const def={ [ROLES.PROJETOS]:[], [ROLES.ESTOQUE]:[], [ROLES.FABRICACAO]:[], [ROLES.PRODUCAO]:[], [ROLES.MARKETING]:[], [ROLES.GRAFICA]:[], [ROLES.LOGISTICA]:[] }; localStorage.setItem(KEY_DATA, JSON.stringify(def)); return def;}
function setData(o){ localStorage.setItem(KEY_DATA, JSON.stringify(o)) }
function getProps(){ try{const p=JSON.parse(localStorage.getItem(KEY_PROPS)); return Array.isArray(p)?p:[]}catch{return[]} }
function setProps(a){ localStorage.setItem(KEY_PROPS, JSON.stringify(a)) }

/* -------- NOVO: solicitações Comercial→Projetos -------- */
function getReqs(){ try{const r=JSON.parse(localStorage.getItem(KEY_REQS)); return Array.isArray(r)?r:[]}catch{return[]} }
function setReqs(a){ localStorage.setItem(KEY_REQS, JSON.stringify(a)) }

/* -------- UI / roteamento -------- */
function initUI(){
  ['pageLogin','pageAdmin','pageDiretoria','pageComercial','pageArea','pageProjetos'].forEach(hide);
  fillDataLists();
  const u=getUser();
  $('userNav').classList.toggle('hide', !u);
  if(!u){ show('pageLogin'); return; }
  $('userName').textContent=u.name||u.username; $('userRole').textContent=u.role;

  if(u.role===ROLES.ADMIN){ show('pageAdmin'); bindAdminTabs(); fillAreaSelect(); renderDashboard(); prepareAccessTab(); return; }
  if(u.role===ROLES.DIRETORIA){ show('pageDiretoria'); renderDirProps(); return; }
  if(u.role===ROLES.PROJETOS){ show('pageProjetos'); renderProjList(); return; }
  if(u.role===ROLES.COMERCIAL){ show('pageComercial'); bindComercialTabs(); renderMyProps(); renderMyReqs(); return; }

  // demais setores → checklist (mantido)
  $('areaTitle').textContent=`Checklist da área — ${u.role}`;
  show('pageArea'); /* você já tinha renderAreaTable etc. no projeto anterior; removido aqui para focar nas novas abas */
}
document.addEventListener('DOMContentLoaded', initUI);

/* -------- login -------- */
function doLogin(ev){
  ev.preventDefault();
  const un=$('inUser').value.trim().toLowerCase();
  const pw=$('inPass').value.trim();
  const user=getUsers().find(u=>u.username.toLowerCase()===un && u.password===pw);
  if(!user){ alert('Usuário ou senha inválidos'); return false; }
  setUser({username:user.username,name:user.name,role:user.role});
  initUI(); return false;
}

/* -------- Admin: abas, acessos e aprovadores -------- */
function bindAdminTabs(){
  const container=$('adminTabs');
  container.querySelectorAll('.tab').forEach(btn=>{
    btn.onclick=()=>{
      container.querySelectorAll('.tab').forEach(b=>b.classList.remove('active'));
      btn.classList.add('active');
      ['panel-dash','panel-area','panel-access'].forEach(hide);
      if(btn.dataset.tab==='dash'){ show('panel-dash'); renderDashboard(); }
      if(btn.dataset.tab==='area'){ show('panel-area'); renderAdminAreaView($('areaSelect').value); }
      if(btn.dataset.tab==='access'){ show('panel-access'); prepareAccessTab(); }
    };
  });
}
function prepareAccessTab(){
  const sel=$('accRole');
  sel.innerHTML=Object.values(ROLES).map(r=>`<option>${r}</option>`).join('');
  renderAccessList();
  renderApprovers();
}
function renderAccessList(){
  const users=getUsers();
  $('userList').innerHTML = users.length? `
  <div style="overflow:auto"><table>
    <thead><tr><th>NOME</th><th>USUÁRIO</th><th>PERFIL</th><th></th></tr></thead>
    <tbody>
      ${users.map(u=>`
        <tr>
          <td>${esc(u.name)}</td>
          <td><code>${esc(u.username)}</code></td>
          <td>${esc(u.role)}</td>
          <td style="text-align:right">
            <button class="btn xs ghost" onclick="resetPassword('${u.username}')">Redefinir senha</button>
            <button class="btn xs warn" onclick="changeRole('${u.username}')">Mudar perfil</button>
            ${u.username==='admin'?'':`<button class="btn xs danger" onclick="deleteUser('${u.username}')">Excluir</button>`}
          </td>
        </tr>`).join('')}
    </tbody>
  </table></div>` : `<p class="muted">Nenhum usuário.</p>`;
}
function createAccess(){
  const name=$('accName').value.trim();
  const username=$('accUser').value.trim().toLowerCase();
  const password=$('accPass').value.trim();
  const role=$('accRole').value;
  if(!name||!username||!password||!role) return alert('Preencha todos os campos.');
  const users=getUsers();
  if(users.some(u=>u.username.toLowerCase()===username)) return alert('Login já existe.');
  users.push({name,username,password,role}); setUsers(users);
  ['accName','accUser','accPass'].forEach(id=>$(id).value=''); $('accRole').selectedIndex=0;
  renderAccessList(); alert('Acesso criado!');
}
function deleteUser(username){ if(!confirm(`Excluir o usuário "${username}"?`)) return; const users=getUsers().filter(u=>u.username!==username); setUsers(users); renderAccessList(); }
function resetPassword(username){ const np=prompt(`Nova senha para "${username}":`,''); if(np===null) return; const users=getUsers(); const u=users.find(x=>x.username===username); if(!u) return; u.password=np.trim(); if(!u.password) return alert('Senha vazia.'); setUsers(users); alert('Senha atualizada!'); }
function changeRole(username){
  const roles=Object.values(ROLES).join(', ');
  const choice=prompt(`Novo perfil para "${username}"\nOpções: ${roles}`, ROLES.COMERCIAL);
  if(choice===null) return;
  if(!Object.values(ROLES).includes(choice)) return alert('Perfil inválido.');
  const users=getUsers(); const u=users.find(x=>x.username===username); if(!u) return;
  u.role=choice; setUsers(users); renderAccessList();
}
/* aprovadores */
function renderApprovers(){
  const list=getApprovers();
  $('dirApproversBox').innerHTML = `
    <h2 style="margin:6px 0 12px">Diretoria — Aprovadores (Nome + PIN)</h2>
    <div style="overflow:auto">
      <table>
        <thead><tr><th>#</th><th>Nome</th><th>PIN</th><th></th></tr></thead>
        <tbody>
          ${list.map((a,i)=>`
            <tr>
              <td>${i+1}</td>
              <td><input id="ap_name_${i}" value="${esc(a.name)}"></td>
              <td><input id="ap_pin_${i}" value="${esc(a.pin)}" maxlength="8"></td>
              <td style="text-align:right">
                <button class="btn xs ok" onclick="saveApprover(${i})">Salvar</button>
                <button class="btn xs danger" onclick="deleteApprover(${i})">Remover</button>
              </td>
            </tr>`).join('')}
        </tbody>
      </table>
    </div>
    <div class="row" style="justify-content:flex-end;margin-top:10px">
      <button class="btn sm" onclick="addApprover()">Adicionar aprovador</button>
    </div>`;
}
function saveApprover(i){
  const list=getApprovers();
  const name=$('ap_name_'+i).value.trim();
  const pin=($('ap_pin_'+i).value||'').trim();
  if(!name||!pin) return alert('Informe nome e PIN.');
  if(!/^[0-9]{4,8}$/.test(pin)) return alert('PIN deve ter 4 a 8 dígitos numéricos.');
  list[i]={name,pin}; setApprovers(list); alert('Aprovador salvo!'); renderApprovers();
}
function deleteApprover(i){ const list=getApprovers(); list.splice(i,1); setApprovers(list); renderApprovers(); }
function addApprover(){ const list=getApprovers(); list.push({name:'Novo Diretor', pin:'0000'}); setApprovers(list); renderApprovers(); }

/* -------- Dashboard & Área (resumo simples) -------- */
function progressOf(area){ const data=getData()[area]||[]; const total=data.length||1; const done=data.filter(r=>r.apIda || r.apVolta).length; return {pct:Math.round(100*done/total),done,total}; }
function renderDashboard(){
  const areas=[ROLES.PROJETOS,ROLES.ESTOQUE,ROLES.FABRICACAO,ROLES.PRODUCAO,ROLES.MARKETING,ROLES.GRAFICA,ROLES.LOGISTICA];
  $('dashCards').innerHTML = areas.map(a=>{ const p=progressOf(a); return `
    <div class="card" style="min-width:280px">
      <div class="row" style="gap:16px;align-items:center">
        <div class="progress" style="width:120px;height:12px"><div class="bar" style="width:${p.pct}%"></div></div>
        <div><div style="font-weight:900">${a}</div><div class="row"><span class="pill">Concl.: ${p.done}</span><span class="pill">Pend.: ${p.total-p.done}</span></div></div>
        <div class="pill">${p.pct}%</div>
      </div>
    </div>`; }).join('');
}
function fillAreaSelect(){
  const sel=$('areaSelect');
  sel.innerHTML=[ROLES.PROJETOS,ROLES.ESTOQUE,ROLES.FABRICACAO,ROLES.PRODUCAO,ROLES.MARKETING,ROLES.GRAFICA,ROLES.LOGISTICA].map(r=>`<option>${r}</option>`).join('');
  sel.onchange=()=>renderAdminAreaView(sel.value);
  renderAdminAreaView(sel.value);
}
function renderAdminAreaView(area){ $('areaWrap').innerHTML = `<p class="muted">Checklist da área <b>${esc(area)}</b> — (tabela suprimida aqui para focar nas novas abas; podemos reativar a grade completa quando quiser)</p>`; }

/* -------- Comercial: abas -------- */
function bindComercialTabs(){
  const sec=$('pageComercial');
  sec.querySelectorAll('.tab').forEach(btn=>{
    btn.onclick=()=>{
      sec.querySelectorAll('.tab').forEach(b=>b.classList.remove('active'));
      sec.querySelectorAll('.panel').forEach(p=>p.classList.add('hide'));
      btn.classList.add('active');
      const id=btn.dataset.tab;
      $('panel-'+id).classList.remove('hide');
      if(id==='prop-my') renderMyProps();
      if(id==='req-my') renderMyReqs();
    };
  });
}

/* -------- Propostas (mantido) -------- */
function enviarProposta(){
  const u=getUser(); if(!u || u.role!==ROLES.COMERCIAL){ alert('Apenas Comercial.'); return; }
  // checagem obrigatória rápida (apenas alguns campos principais)
  const need=['pIni','pVend','pShop','pTotalLojas','pCRM','pVagas','pAdm','pRank','pExec','pTel','pEnd','pMontNoite','pDesmNoite','pDias','pFeriados','pTema','pM2','pLic','pPisos','pValor','pPe','pPracaProp','pQtdPracas','pConc','pBilheteConc','pTemaAnt','pRefParque','pPeriodo','pAluguel','pFaturamento','pCP1','pCP2','pCP3','pCP4','pConsider','pExig','pCond','pComissao'];
  for(const id of need){ if(!$(id).value.trim()){ alert('Preencha todos os campos obrigatórios da Proposta.'); return; } }
  const p={
    id:'P'+Date.now(), createdAt:new Date().toISOString(),
    createdBy:u.username, createdByName:u.name,
    dados:{
      ini:$('pIni').value, vendedor:$('pVend').value,
      shop:$('pShop').value, totalLojas:$('pTotalLojas').value, crm:$('pCRM').value,
      vagas:$('pVagas').value, adm:$('pAdm').value, rank:$('pRank').value, exec:$('pExec').value,
      tel:$('pTel').value, end:$('pEnd').value,
      montNoite:$('pMontNoite').value, desmNoite:$('pDesmNoite').value, dias:$('pDias').value, feriados:$('pFeriados').value,
      tema:$('pTema').value, m2:$('pM2').value, lic:$('pLic').value, pisos:$('pPisos').value, valor:$('pValor').value,
      pe:$('pPe').value, pracaProp:$('pPracaProp').value, qtdPracas:$('pQtdPracas').value,
      conc:$('pConc').value, bilheteConc:$('pBilheteConc').value,
      temaAnt:$('pTemaAnt').value, refParque:$('pRefParque').value, periodo:$('pPeriodo').value,
      aluguel:$('pAluguel').value, faturamento:$('pFaturamento').value,
      cp1:$('pCP1').value, cp2:$('pCP2').value, cp3:$('pCP3').value, cp4:$('pCP4').value,
      consider:$('pConsider').value, exig:$('pExig').value, cond:$('pCond').value, gold:$('pGold').value, comissao:$('pComissao').value
    },
    status:'PENDENTE',
    decision:null
  };
  const all=getProps(); all.unshift(p); setProps(all);
  alert('Proposta enviada à Diretoria!');
  // troca para "Minhas Propostas"
  const sec=$('pageComercial');
  sec.querySelectorAll('.tab').forEach(b=>b.classList.remove('active'));
  sec.querySelector('[data-tab="prop-my"]').classList.add('active');
  ['panel-prop-new','panel-previa-new','panel-proj-new','panel-req-my'].forEach(hide);
  show('panel-prop-my'); renderMyProps();
}
function statusBadge(st){ const c={PENDENTE:'#9ca3af',APROVADO:'#22c55e',NEGADO:'#ef4444','VISTO':'#60a5fa','EM ANDAMENTO':'#f59e0b','PRONTO':'#22c55e','FINALIZADO':'#10b981'}[st]||'#9ca3af'; return `<span class="pill" style="color:${c};border-color:#2a3b66">${st}</span>`}
function propsTable(list, canAct){
  if(!list.length) return `<p class="muted">Nenhuma entrada.</p>`;
  const rows=list.map(p=>{
    const d=p.dados||{}; const dt=new Date(p.createdAt).toLocaleString();
    const dec=p.decision?`<div class="s muted">Por: <b>${esc(p.decision.name)}</b> em ${new Date(p.decision.when).toLocaleString()}<br>Obs.: ${esc(p.decision.obs||'-')}</div>`:'';
    return `<tr>
      <td><strong>${esc(p.id)}</strong><br><span class="s muted">${dt}</span></td>
      <td><b>${esc(d.shop||'-')}</b><br><span class="s muted">${esc(d.tema||'-')}</span></td>
      <td>${statusBadge(p.status||'')}</td>
      <td style="text-align:right">${canAct?dirActions(p.id):''}</td>
    </tr>`;
  }).join('');
  return `<div style="overflow:auto"><table>
    <thead><tr><th>ID</th><th>Resumo</th><th>Status</th><th></th></tr></thead>
    <tbody>${rows}</tbody></table></div>`;
}
function renderMyProps(){ const u=getUser(); if(!u) return; $('myPropsWrap').innerHTML=propsTable(getProps().filter(p=>p.createdBy===u.username), false); }

/* -------- Diretoria (propostas antigas): mantém visualização completa + decisão com PIN -------- */
function renderDirProps(){ $('dirPropsWrap').innerHTML = propsTable(getProps(), true); $('dirPropDetail').innerHTML=''; }
function dirActions(id){ return `<div class="row" style="justify-content:flex-end"><button class="btn xs ghost" onclick="verProposta('${id}')">Abrir</button><button class="btn xs ok" onclick="aprovarProposta('${id}')">Aprovar</button><button class="btn xs danger" onclick="negarProposta('${id}')">Negar</button></div>`; }
function verProposta(id){
  const p=getProps().find(x=>x.id===id); if(!p) return;
  const d=p.dados||{};
  $('dirPropDetail').innerHTML = `
    <div class="card" style="margin-top:12px"><h3 style="margin:0 0 10px">Proposta ${esc(p.id)} — ${esc(d.shop||'')}</h3>
    <!-- (campos exibidos readonly como no envio) -->
    ${Object.entries(d).map(([k,v])=>`<div class="field"><label>${esc(k)}</label><input readonly value="${esc(v||'')}"></div>`).join('')}
    </div>`;
}
function aprovarProposta(id){ decidirProposta(id,true); }
function negarProposta(id){ decidirProposta(id,false); }
function decidirProposta(id,isApprove){
  const list=getApprovers(); if(!list.length) return alert('Nenhum aprovador cadastrado.');
  const nomes=list.map(a=>a.name).join('\n - ');
  const nome=prompt(`Digite seu NOME exatamente como cadastrado:\n - ${nomes}\n\nNome:`, ''); if(nome===null) return;
  const ap=list.find(a=>a.name.trim().toLowerCase()===String(nome).trim().toLowerCase()); if(!ap) return alert('Nome não encontrado.');
  const pin=prompt(`Olá, ${ap.name}. PIN para ${isApprove?'aprovar':'negar'}:`, ''); if(pin===null) return; if(ap.pin!==String(pin)) return alert('PIN inválido.');
  const obs=prompt('Observação (opcional):','')||'';
  const all=getProps(); const p=all.find(x=>x.id===id); if(!p) return;
  p.status=isApprove?'APROVADO':'NEGADO'; p.decision={ by:ap.name, name:ap.name, when:new Date().toISOString(), obs };
  setProps(all); alert(isApprove?'Proposta aprovada!':'Proposta negada.'); renderDirProps();
}

/* -------- NOVO: Envio de Solicitações (Prévia/Projeto) -------- */
function validarObrigatorios(ids){ for(const id of ids){ if(!$(id) || !$(id).value || !String($(id).value).trim()){ $(id)?.focus(); return false; } } return true; }

function enviarSolicitacao(tipo){
  const u=getUser(); if(!u || u.role!==ROLES.COMERCIAL){ alert('Apenas Comercial.'); return; }
  if(tipo==='PREVIA'){
    const need=['prevTipo','prevApres','prevVendedor','prevShop','prevUF','prevExig','prevCidade','prevTema','prevPraca','prevM2'];
    if(!validarObrigatorios(need)){ alert('Preencha todos os campos da Prévia.'); return; }
    const req={
      id:'R'+Date.now(), kind:'PREVIA', createdAt:new Date().toISOString(),
      createdBy:u.username, createdByName:u.name,
      dados:{
        tipo:$('prevTipo').value, apresentacao:$('prevApres').value, vendedor:$('prevVendedor').value,
        shopping:$('prevShop').value, uf:$('prevUF').value, exig:$('prevExig').value,
        cidade:$('prevCidade').value, tema:$('prevTema').value, praca:$('prevPraca').value, m2:$('prevM2').value
      },
      status:'RECEBIDO', historico:[{on:new Date().toISOString(), st:'RECEBIDO'}]
    };
    const all=getReqs(); all.unshift(req); setReqs(all);
    alert('Prévia enviada para Projetos!');
  }
  if(tipo==='PROJETO'){
    const need=['projTipo','projVendedor','projShop','projUF','projCidade','projPraca','projM2','projTema','projIni','projFim','projMont','projDesm','projRazao','projLojaRef','projC1Nome','projC1Mail','projC1Fone','projC2Nome','projC2Mail','projC2Fone'];
    for(let i=0;i<=10;i++) need.push('doc_'+i);
    if(!validarObrigatorios(need)){ alert('Preencha todos os campos do Projeto.'); return; }
    const docs={}; for(let i=0;i<=10;i++){ docs['d'+i]=$('doc_'+i).value; }
    const req={
      id:'R'+Date.now(), kind:'PROJETO', createdAt:new Date().toISOString(),
      createdBy:u.username, createdByName:u.name,
      dados:{
        tipo:$('projTipo').value, vendedor:$('projVendedor').value,
        shopping:$('projShop').value, uf:$('projUF').value, cidade:$('projCidade').value,
        praca:$('projPraca').value, m2:$('projM2').value, tema:$('projTema').value,
        periodoIni:$('projIni').value, periodoFim:$('projFim').value,
        montagem:$('projMont').value, desmontagem:$('projDesm').value,
        razao:$('projRazao').value, lojaRef:$('projLojaRef').value,
        contatos:[
          {nome:$('projC1Nome').value, email:$('projC1Mail').value, fone:$('projC1Fone').value},
          {nome:$('projC2Nome').value, email:$('projC2Mail').value, fone:$('projC2Fone').value},
        ],
        docs
      },
      status:'RECEBIDO', historico:[{on:new Date().toISOString(), st:'RECEBIDO'}]
    };
    const all=getReqs(); all.unshift(req); setReqs(all);
    alert('Projeto enviado para Projetos!');
  }
  renderMyReqs();
  // muda para aba "Minhas Solicitações"
  const sec=$('pageComercial');
  sec.querySelectorAll('.tab').forEach(b=>b.classList.remove('active'));
  sec.querySelector('[data-tab="req-my"]').classList.add('active');
  ['panel-prop-new','panel-prop-my','panel-previa-new','panel-proj-new'].forEach(hide);
  show('panel-req-my');
}

/* -------- Comercial: Minhas Solicitações -------- */
function renderMyReqs(){
  const u=getUser(); if(!u) return;
  const list=getReqs().filter(r=>r.createdBy===u.username);
  $('myReqsWrap').innerHTML = reqTable(list,false);
}

/* -------- Projetos: Receber & dar status -------- */
function renderProjList(){
  const list=getReqs();
  $('projList').innerHTML = reqTable(list,true);
  $('projDetail').innerHTML='';
}
function reqTable(list, canAct){
  if(!list.length) return `<p class="muted">Nenhuma solicitação.</p>`;
  const rows=list.map(r=>{
    const d=r.dados||{}, dt=new Date(r.createdAt).toLocaleString();
    const resumo = r.kind==='PREVIA'
      ? `${esc(d.shopping||'-')} • ${esc(d.tema||'-')} • ${esc(d.apresentacao||'-')}`
      : `${esc(d.shopping||'-')} • ${esc(d.tema||'-')} • ${esc(d.periodoIni||'')}→${esc(d.periodoFim||'')}`;
    return `<tr>
      <td><strong>${esc(r.id)}</strong><br><span class="s muted">${dt}</span></td>
      <td>${resumo}</td>
      <td>${statusBadge(r.status)}</td>
      <td style="text-align:right">${canAct?projActions(r.id):''}</td>
    </tr>`;
  }).join('');
  return `<div style="overflow:auto"><table>
    <thead><tr><th>ID</th><th>Resumo</th><th>Status</th><th></th></tr></thead>
    <tbody>${rows}</tbody></table></div>`;
}
function projActions(id){
  return `<div class="row" style="justify-content:flex-end">
    <button class="btn xs ghost" onclick="projAbrir('${id}')">Abrir</button>
    <button class="btn xs" onclick="projSet('${id}','VISTO')">Visto</button>
    <button class="btn xs warn" onclick="projSet('${id}','EM ANDAMENTO')">Em andamento</button>
    <button class="btn xs ok" onclick="projSet('${id}','PRONTO')">Pronto</button>
    <button class="btn xs danger" onclick="projSet('${id}','FINALIZADO')">Finalizado</button>
  </div>`;
}
function projAbrir(id){
  const r=getReqs().find(x=>x.id===id); if(!r) return;
  const d=r.dados||{};
  const bloco = r.kind==='PREVIA' ? `
    <div class="grid-3">
      <div class="field"><label>Tipo</label><input readonly value="${esc(d.tipo||'')}"></div>
      <div class="field"><label>Apresentação</label><input readonly value="${esc(d.apresentacao||'')}"></div>
      <div class="field"><label>Vendedor</label><input readonly value="${esc(d.vendedor||'')}"></div>
      <div class="field"><label>Shopping</label><input readonly value="${esc(d.shopping||'')}"></div>
      <div class="field"><label>UF</label><input readonly value="${esc(d.uf||'')}"></div>
      <div class="field"><label>Nível de exigência</label><input readonly value="${esc(d.exig||'')}"></div>
      <div class="field"><label>Cidade/UF</label><input readonly value="${esc(d.cidade||'')}"></div>
      <div class="field"><label>Tema</label><input readonly value="${esc(d.tema||'')}"></div>
      <div class="field"><label>Praça</label><input readonly value="${esc(d.praca||'')}"></div>
      <div class="field"><label>Metragem (m²)</label><input readonly value="${esc(d.m2||'')}"></div>
    </div>` :
    `
    <div class="grid-3">
      <div class="field"><label>Tipo</label><input readonly value="${esc(d.tipo||'')}"></div>
      <div class="field"><label>Vendedor</label><input readonly value="${esc(d.vendedor||'')}"></div>
      <div class="field"><label>Shopping</label><input readonly value="${esc(d.shopping||'')}"></div>
      <div class="field"><label>UF</label><input readonly value="${esc(d.uf||'')}"></div>
      <div class="field"><label>Cidade/UF</label><input readonly value="${esc(d.cidade||'')}"></div>
      <div class="field"><label>Praça</label><input readonly value="${esc(d.praca||'')}"></div>
      <div class="field"><label>Metragem (m²)</label><input readonly value="${esc(d.m2||'')}"></div>
      <div class="field"><label>Tema</label><input readonly value="${esc(d.tema||'')}"></div>
      <div class="field"><label>Período</label><input readonly value="${esc(d.periodoIni||'')} → ${esc(d.periodoFim||'')}"></div>
      <div class="field"><label>Montagem</label><input readonly value="${esc(d.montagem||'')}"></div>
      <div class="field"><label>Desmontagem</label><input readonly value="${esc(d.desmontagem||'')}"></div>
      <div class="field"><label>Razão social</label><input readonly value="${esc(d.razao||'')}"></div>
      <div class="field" style="grid-column:1/-1"><label>Loja ref.</label><input readonly value="${esc(d.lojaRef||'')}"></div>
      <div class="field" style="grid-column:1/-1"><label>Contatos</label><textarea rows="3" readonly>${esc(JSON.stringify(d.contatos||[],null,2))}</textarea></div>
      <div class="field" style="grid-column:1/-1"><label>Documentos</label><textarea rows="3" readonly>${esc(JSON.stringify(d.docs||{},null,2))}</textarea></div>
    </div>`;
  $('projDetail').innerHTML = `<div class="card" style="margin-top:12px"><h3 style="margin:0 0 10px">${esc(r.kind)} — ${esc(r.id)}</h3>${bloco}
    <div class="row" style="justify-content:flex-end;margin-top:10px">${projActions(r.id)}</div>
  </div>`;
}
function projSet(id, st){
  const all=getReqs(); const r=all.find(x=>x.id===id); if(!r) return;
  r.status=st; (r.historico=r.historico||[]).push({on:new Date().toISOString(), st});
  setReqs(all); renderProjList(); alert('Status atualizado para: '+st);
}

/* -------- tabela simples reuso -------- */
function renderAdminAreaView(area){ $('areaWrap').innerHTML=`<p class="muted">Área: <b>${esc(area)}</b> (visual simplificado)</p>`; }
function exportAreaCSV(){ alert('Export CSV — placeholder'); }
/* -------- fim JS -------- */
</script>

</body>
</html>
